<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å®¤åº§ä½ç¥ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- XLSX: ç”¨æ–¼åŒ¯å…¥ -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- DOCX: ç”¨æ–¼åŒ¯å‡º Word -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <!-- html2canvas: ç”¨æ–¼åŒ¯å‡ºåœ–ç‰‡ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- DragDropTouch: æ‰‹æ©Ÿæ”¯æ´ -->
    <script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        :root { --desk-min-height: 85px; --desk-width: 110px; }
        
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; font-size: 14px; overflow-x: hidden; }
        
        /* Desk Styles */
        .desk { transition: all 0.2s ease; cursor: grab; position: relative; border: 1px solid #cbd5e1; border-radius: 0.375rem; min-height: var(--desk-min-height); width: var(--desk-width); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0.4rem; box-sizing: border-box; margin: 3px; background-color: white; overflow: visible; user-select: none; }
        .desk:hover { transform: translateY(-2px); box-shadow: 0 6px 10px -3px rgba(0, 0, 0, 0.1); z-index: 10; }
        
        /* Drag Styles */
        .desk.sortable-ghost { opacity: 0.3; background-color: #e2e8f0 !important; border: 2px dashed #94a3b8 !important; }
        .desk.sortable-drag { opacity: 1; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); z-index: 9999 !important; transform: scale(1.05); cursor: grabbing; }
        .desk.is-dragging-source { opacity: 0.4; border: 2px dashed #9ca3af; }
        .desk.drag-over-target { border: 2px solid #f87171 !important; background-color: #fef2f2 !important; transform: scale(1.05); box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); z-index: 50; }
        #waitingBench.drag-over-target { background-color: #dbeafe !important; border-color: #3b82f6 !important; }

        /* Locked Desk Style */
        .desk.is-locked { border: 2px solid #f59e0b !important; background-color: #fffbeb; cursor: not-allowed !important; }
        .lock-btn { position: absolute; top: 3px; right: 3px; width: 16px; height: 16px; color: #9ca3af; cursor: pointer; z-index: 20; display: flex; align-items: center; justify-content: center; transition: color 0.2s; font-size: 11px; }
        .desk:hover .lock-btn { color: #6b7280; }
        .desk.is-locked .lock-btn { color: #f59e0b; }

        /* Waiting Bench */
        #waitingBench { min-height: 80px; background-color: #f3f4f6; border: 2px dashed #d1d5db; border-radius: 0.5rem; display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; align-items: center; transition: background-color 0.3s; }
        
        /* Layout & Objects */
        .classroom-object { background-color: #a8a29e; border: 2px solid #78716c; color: white; font-weight: 500; display: flex; align-items: center; justify-content: center; border-radius: 0.375rem; }
        .blackboard { height: 45px; font-size: 0.9em; }
        .teacher-desk-object { height: 35px; width: 90px; background-color: #7c3aed; border-color: #5b21b6; font-size: 0.9em; }
        
        #seatingChart.mode-traditional { display: grid; gap: 6px; justify-content: center; padding: 5px; }
        .mode-traditional .desk:not(.empty-seat):not(.is-locked) { border-color: #93c5fd; }
        .mode-traditional .empty-seat { background-color: #f8fafc; border-color: #e2e8f0; color: #94a3b8; cursor: grab; }
        
        #seatingChart.mode-group { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; padding: 10px; align-items: flex-start; }
        
        /* Group Container */
        .group-container { position: relative; border: 2px dashed #a1a1aa; padding: 5px; padding-top: 28px; border-radius: 0.5rem; display: grid; grid-template-columns: repeat(2, auto); gap: 4px; background-color: rgba(241, 245, 249, 0.6); align-content: start; min-height: 100px; width: fit-content; height: fit-content; margin: 5px; transition: box-shadow 0.2s ease; cursor: move; }
        .group-container.sortable-ghost { opacity: 0.5; background: #e0e7ff; border: 2px dashed #6366f1; }
        
        /* Group UI */
        .group-name-container { position: absolute; top: 3px; left: 5px; right: 25px; display: flex; align-items: center; height: 20px; }
        .group-name-display { font-size: 11px; font-weight: bold; color: #4b5563; padding: 1px 4px; border-radius: 3px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; background-color: rgba(255,255,255,0.6); transition: background-color 0.2s; min-height: 16px; }
        .group-name-display:hover { background-color: rgba(255,255,255,0.9); }
        .group-name-input { font-size: 11px; padding: 0px 3px; border: 1px solid #ccc; border-radius: 3px; width: 100%; height: 18px; box-sizing: border-box; outline: none; display: none; }
        .group-name-display.editing { display: none; }
        .group-name-input.editing { display: block; }
        
        /* Buttons */
        .delete-seat-btn { position: absolute; top: 1px; right: 1px; width: 14px; height: 14px; background-color: #f87171; color: white; border-radius: 50%; font-size: 9px; line-height: 14px; text-align: center; cursor: pointer; opacity: 0; transition: opacity 0.2s; z-index: 15; pointer-events: none; }
        .mode-group .empty-seat:hover .delete-seat-btn { opacity: 0.8; pointer-events: auto; }
        .delete-seat-btn:hover { background-color: #ef4444; opacity: 1; }
        .delete-group-btn { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background-color: #ef4444; color: white; border-radius: 3px; font-size: 10px; line-height: 18px; text-align: center; cursor: pointer; opacity: 0.7; z-index: 25; display: flex; align-items: center; justify-content: center; }
        .delete-group-btn:hover { opacity: 1; background-color: #dc2626; }
        
        /* --- DYNAMIC DISPLAY STYLES (Controlled by JS Classes on #classroomLayout) --- */
        
        /* 1. GENDER COLOR */
        /* Default (Hidden) */
        .desk.male, .desk.female { background-color: white; border-left: 1px solid #cbd5e1; }
        /* Visible */
        .view-style-gender-color .male { border-left: 4px solid #60a5fa; background-color: #f0f9ff; }
        .view-style-gender-color .female { border-left: 4px dashed #f472b6; background-color: #fdf4ff; }

        /* 2. GENDER SYMBOL */
        .gender-symbol { display: none; font-size: 0.9em; margin-left: 3px; font-weight: bold; }
        .view-style-gender-symbol .gender-symbol { display: inline; }
        .male .gender-symbol { color: #3b82f6; }
        .female .gender-symbol { color: #ec4899; }

        /* 3. NEEDS (REQUIREMENT: Show text on screen/image if toggled) */
        .desk-needs-display { display: none; font-size: 0.7rem; color: #475569; margin-top: 2px; text-align: center; width: 100%; word-wrap: break-word; line-height: 1.1; background-color: rgba(255,255,255,0.5); border-radius: 2px; }
        .view-style-needs .desk-needs-display { display: block; }
        /* Tooltip Icon */
        .needs-icon { display: block; position: absolute; bottom: 3px; right: 3px; font-size: 0.85rem; color: #64748b; background-color: rgba(255, 255, 255, 0.7); padding: 1px 2px; border-radius: 3px; z-index: 15; cursor: help; }
        .tooltip { visibility: hidden; width: max-content; max-width: 140px; background-color: #334155; color: #fff; text-align: center; border-radius: 4px; padding: 4px 7px; position: absolute; z-index: 99; bottom: 105%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; font-size: 0.7rem; pointer-events: none; word-wrap: break-word; }
        .needs-icon:hover .tooltip { visibility: visible; opacity: 1; }

        /* 4. EMPTY SEATS */
        .view-style-hide-empty .empty-seat { visibility: hidden; border-color: transparent !important; background-color: transparent !important; pointer-events: none; }
        .view-style-hide-empty .group-container.all-empty { display: none; } /* JS helper for empty groups */

        /* 5. GROUP NAMES */
        .view-style-hide-group-names .group-name-container { display: none; }

        /* 6. ANONYMOUS */
        .name-full { display: inline; }
        .name-anon { display: none; }
        .view-style-anonymous .name-full { display: none; }
        .view-style-anonymous .name-anon { display: inline; }

        /* General Text Info */
        .student-info { display: flex; flex-direction: column; align-items: center; width: 100%; text-align: center; justify-content: center; height: 100%; }
        .student-name-line { 
            font-weight: 600; 
            font-size: 1.1em; 
            color: #1f2937; 
            width: 100%; 
            margin-bottom: 2px; 
            white-space: nowrap; 
            overflow: visible; 
            line-height: 1.3;
        }

        .controls-section { padding: 1rem; }
        @media (min-width: 1024px) { #controls-column { max-height: calc(100vh - 70px - 50px); overflow-y: auto; scrollbar-width: thin; } }

        /* Mascot */
        #mascot { position: fixed; bottom: 20px; left: 20px; width: 100px; height: auto; cursor: move; transition: transform 0.1s; z-index: 999; touch-action: none; }
        #mascot:hover { filter: brightness(1.1); }
        .particle { position: fixed; width: 10px; height: 10px; border-radius: 50%; pointer-events: none; z-index: 1001; transition: transform 1s ease-out, opacity 1s ease-out; }

        /* No Print Utility */
        .no-print { } /* Used by JS to filter html2canvas */
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-cyan-600 to-blue-600 text-white py-4 shadow-lg no-print">
        <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center">
            <div class="mb-3 md:mb-0 text-center md:text-left flex items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold">æ•™å®¤åº§ä½ç¥ç®¡ç†ç³»çµ± <span class="text-yellow-300 text-sm italic">Pro</span></h1>
                    <p class="text-blue-100 text-xs">éˆæ´»ç¥å®‰æ’*è¦–è¦ºç¥ç®¡ç†</p>
                </div>
                <div class="flex gap-2">
                    <button id="undoBtn" class="bg-white/20 hover:bg-white/30 text-white p-2 rounded-full w-8 h-8 flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed transition" title="å¾©åŸ (Ctrl+Z)">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button id="redoBtn" class="bg-white/20 hover:bg-white/30 text-white p-2 rounded-full w-8 h-8 flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed transition" title="é‡åš (Ctrl+Y)">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="saveProjectBtn" class="bg-blue-700 hover:bg-blue-800 text-white px-3 py-1.5 rounded text-sm flex items-center shadow"><i class="fas fa-save mr-1"></i> å„²å­˜å°ˆæ¡ˆ</button>
                <label for="loadProjectInput" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-1.5 rounded text-sm flex items-center shadow cursor-pointer">
                    <i class="fas fa-folder-open mr-1"></i> è®€å–å°ˆæ¡ˆ
                    <input type="file" id="loadProjectInput" accept=".json" class="hidden">
                </label>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-2 md:px-4 py-4 print-container flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- CONTROLS COLUMN -->
        <div id="controls-column" class="lg:col-span-1 space-y-5 no-print">
            <div class="bg-white rounded-lg shadow-md controls-section">
                <h2 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">åŸºæœ¬è¨­å®š</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-1 font-medium text-sm">ç­ç´šåç¨±</label>
                    <input type="text" id="classNameInput" class="w-full px-3 py-1.5 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="ä¾‹å¦‚ï¼šç¥ä¾†ä¸€ç­">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-1 font-medium text-sm">åº§ä½æ¨¡å¼</label>
                    <div class="flex gap-4 text-sm bg-gray-50 p-2 rounded">
                        <label class="inline-flex items-center cursor-pointer"><input type="radio" class="form-radio text-blue-600 h-4 w-4" name="seatingMode" value="traditional" checked><span class="ml-1">å‚³çµ±çŸ©é™£</span></label>
                        <label class="inline-flex items-center cursor-pointer"><input type="radio" class="form-radio text-green-600 h-4 w-4" name="seatingMode" value="group"><span class="ml-1">åˆ†çµ„åº§ä½</span></label>
                    </div>
                </div>
                <div id="traditionalInputs" class="grid grid-cols-2 gap-4 mb-2">
                    <div><label class="text-gray-700 font-medium text-xs">åˆ—æ•¸ (ç›´)</label><input type="number" id="rows" min="1" max="20" value="4" class="w-full px-3 py-1 border rounded text-sm"></div>
                    <div><label class="text-gray-700 font-medium text-xs">è¡Œæ•¸ (æ©«)</label><input type="number" id="cols" min="1" max="20" value="6" class="w-full px-3 py-1 border rounded text-sm"></div>
                </div>
                <div id="groupInputs" class="hidden space-y-3">
                     <div class="grid grid-cols-2 gap-4">
                         <div><label class="text-gray-700 font-medium text-xs">åˆ†çµ„æ•¸é‡</label><input type="number" id="numGroups" min="0" max="25" value="5" class="w-full px-3 py-1 border rounded text-sm"></div>
                         <div><label class="text-gray-700 font-medium text-xs">æ¯çµ„äººæ•¸</label><input type="number" id="studentsPerGroup" min="1" max="12" value="4" class="w-full px-3 py-1 border rounded text-sm"></div>
                     </div>
                     <button id="addGroupBtn" class="bg-green-600 hover:bg-green-700 text-white py-1.5 w-full rounded text-sm shadow-sm"><i class="fas fa-plus-circle mr-1"></i> æ–°å¢ä¸€å€‹å°çµ„</button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md controls-section">
                 <h2 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">å­¸ç”Ÿåå–®èˆ‡æ’åˆ—</h2>
                 <div class="space-y-3">
                    <div>
                        <textarea id="students" rows="5" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 text-sm font-mono leading-tight" placeholder="1 å…¬å°æ°‘ ç”· éœ€è¦æé†’&#10;2 é‚±å°ç‘œ å¥³ æ²‰ç™®AIç„¡æ³•è‡ªæ‹”
..."></textarea>
                        <p class="text-xs text-gray-500 mt-1 flex justify-between">
                            <span>æ ¼å¼: åº§è™Ÿ å§“å æ€§åˆ¥ (å‚™è¨»)</span>
                            <a href="#" id="downloadTemplateBtn" class="text-blue-600 hover:text-blue-800"><i class="fas fa-download"></i> ç¯„ä¾‹</a>
                        </p>
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="refreshStudentListBtn" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white py-1.5 rounded text-sm shadow-sm" title="æ›´æ–°è³‡æ–™ä½†ä¸æ‰“äº‚ä½ç½®"><i class="fas fa-sync-alt mr-1"></i> åˆ·æ–°åå–®</button>
                        <button id="clearLayoutBtn" class="bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 py-1.5 px-3 rounded text-sm shadow-sm" title="æ¸…ç©ºåº§ä½å›åˆ°æš«å­˜å€"><i class="fas fa-trash-alt"></i> æ¸…ç©ºåº§ä½</button>
                    </div>
                    <div class="flex items-center relative w-full">
                            <input type="file" id="excelFile" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <button class="w-full bg-blue-50 text-blue-700 border border-blue-200 hover:bg-blue-100 py-1.5 rounded text-sm"><i class="fas fa-file-excel mr-1"></i> åŒ¯å…¥ Excel</button>
                    </div>

                    <div class="border-t pt-3 mt-2">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="includeBenchInShuffle" class="h-4 w-4 text-indigo-600 rounded border-gray-300">
                            <label for="includeBenchInShuffle" class="ml-2 text-sm text-gray-700">éš¨æ©Ÿæ™‚åŒ…å«æš«å­˜å€å­¸ç”Ÿ</label>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="sequentialArrangeBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-1.5 rounded text-sm shadow-sm"><i class="fas fa-sort-numeric-down mr-1"></i> ä¾åº§è™Ÿæ’åˆ—</button>
                            <button id="randomizeBtn" class="bg-purple-600 hover:bg-purple-700 text-white py-1.5 rounded text-sm shadow-sm"><i class="fas fa-random mr-1"></i> éš¨æ©Ÿæ’åˆ—</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 text-center">ğŸ’¡ æç¤ºï¼šé»æ“Šåº§ä½å³ä¸Šè§’ <i class="fas fa-lock text-[10px]"></i> å¯é–å®šè©²ç”Ÿ</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md controls-section">
                <h2 class="text-lg font-bold text-gray-800 mb-2">é¡¯ç¤ºèˆ‡åŒ¯å‡ºè¨­å®š</h2>
                <div class="space-y-3">
                    <div class="flex gap-2">
                        <button id="perspectiveToggleBtn" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-1.5 rounded text-xs"><i class="fas fa-sync-alt mr-1"></i> åˆ‡æ›è¦–è§’</button>
                        <button id="toggleBlackboardBtn" class="flex-1 bg-stone-500 hover:bg-stone-600 text-white py-1.5 rounded text-xs"><i class="fas fa-eye-slash"></i> é»‘æ¿</button>
                        <button id="toggleTeacherDeskBtn" class="flex-1 bg-violet-500 hover:bg-violet-600 text-white py-1.5 rounded text-xs"><i class="fas fa-eye-slash"></i> è¬›æ¡Œ</button>
                    </div>
                    
                    <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                        <span class="text-xs font-bold text-gray-700 block mb-2"><i class="fas fa-hand-pointer mr-1"></i> æ‹–æ›³æ¨¡å¼:</span>
                        <div class="flex flex-col gap-2 text-xs">
                            <label class="inline-flex items-center cursor-pointer p-1.5 bg-white border border-gray-200 rounded hover:border-red-400 transition-colors">
                                <input type="radio" name="dragMode" value="swap" class="text-red-600 h-4 w-4" checked>
                                <div class="ml-2">
                                    <span class="font-bold text-red-700 block">å…©å…©äº’æ›æ¨¡å¼</span>
                                    <span class="text-gray-500 block">ä¸å½±éŸ¿ä»–äººåº§ä½</span>
                                </div>
                            </label>
                            <label class="inline-flex items-center cursor-pointer p-1.5 bg-white border border-gray-200 rounded hover:border-indigo-400 transition-colors">
                                <input type="radio" name="dragMode" value="insert" class="text-indigo-600 h-4 w-4">
                                <div class="ml-2">
                                    <span class="font-bold text-indigo-700 block">éè£œé †å»¶æ¨¡å¼</span>
                                    <span class="text-gray-500 block">æœƒå½±éŸ¿ä»–äººåº§ä½</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-y-1 gap-x-2 text-xs">
                        <label class="inline-flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="showGenderColorCheckbox" checked class="text-pink-600 rounded mr-1">é¡¯ç¤ºæ€§åˆ¥è‰²å¡Š</label>
                        <label class="inline-flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="showNeedsCheckbox" checked class="text-cyan-600 rounded mr-1">é¡¯ç¤ºéœ€æ±‚è¨»è¨˜</label>
                        <label class="inline-flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="showGenderSymbolCheckbox" checked class="text-pink-600 rounded mr-1">é¡¯ç¤ºæ€§åˆ¥</label>
                        <label class="inline-flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="showEmptySeatsCheckbox" checked class="text-slate-600 rounded mr-1">é¡¯ç¤ºç©ºä½</label>
                        <label class="inline-flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="showGroupNamesCheckbox" checked class="text-blue-600 rounded mr-1">é¡¯ç¤ºçµ„å</label>
                        <label class="inline-flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="showAnonymousCheckbox" class="text-gray-600 rounded mr-1">é¡¯ç¤ºåŒ¿å(ä¸­é–“O)</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- PREVIEW COLUMN -->
        <div id="preview-column" class="lg:col-span-2 h-full flex flex-col">
             <div id="classroomLayout" class="bg-gray-100 rounded-lg shadow-inner p-2 md:p-4 classroom-layout relative overflow-hidden flex flex-col h-full">
                 
                 <!-- Header & Actions -->
                 <div class="flex justify-between items-start mb-2 relative z-10">
                     <div class="w-full">
                        <h3 id="printClassName" class="text-center text-2xl font-bold hidden mb-4"></h3>
                        <h2 id="webClassName" class="text-center text-xl font-bold text-gray-800 min-h-[1.75rem]"></h2>
                        <div id="classInfo" class="text-gray-600 text-xs font-medium text-center mt-1"></div>
                     </div>
                     <div class="flex gap-2 no-print absolute right-0 top-0">
                         <button id="exportImageBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded text-sm shadow"><i class="fas fa-image mr-1"></i> åŒ¯å‡º åœ–ç‰‡</button>
                         <button id="exportLayoutBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm shadow"><i class="fas fa-file-word mr-1"></i> åŒ¯å‡º Word</button>
                     </div>
                 </div>

                 <!-- Waiting Bench -->
                 <div id="waitingBenchContainer" class="no-print mb-4 z-10">
                    <div class="flex items-center justify-between mb-1 px-1">
                        <span class="text-xs font-bold text-indigo-600"><i class="fas fa-chair mr-1"></i> æš«å­˜å€ / ç­‰å€™å€</span>
                        <span class="text-[10px] text-gray-500">å¯å°‡å­¸ç”Ÿæ‹–æ›³è‡³æ­¤æš«æ”¾</span>
                    </div>
                    <div id="waitingBench" class="shadow-inner min-h-[60px] p-2 bg-gray-50 rounded border-2 border-dashed border-gray-300 flex flex-wrap gap-2 transition-colors">
                        <!-- Dynamic items -->
                    </div>
                 </div>

                 <!-- Main Layout Area -->
                 <div class="flex flex-col flex-grow overflow-auto relative z-0">
                     <div id="classroomObjectsContainerTop" class="mb-2 min-h-[10px] flex items-center justify-center shrink-0 transition-all">
                        <div id="blackboardObject" class="classroom-object blackboard hidden w-3/4 max-w-md shadow-md"><i class="fas fa-chalkboard mr-2"></i> é»‘æ¿</div>
                     </div>
                     <div id="teacherDeskContainerTop" class="mb-2 min-h-[10px] flex items-center justify-center shrink-0 transition-all">
                        <div id="teacherDeskObject" class="classroom-object teacher-desk-object hidden shadow-md"><i class="fas fa-person-chalkboard mr-2"></i> è¬›æ¡Œ</div>
                     </div>
                     
                     <div id="seatingChartWrapper" class="flex-grow overflow-auto p-1">
                         <div id="seatingChart" class="min-h-[300px] rounded bg-white shadow-sm pb-8 transition-all"></div>
                     </div>

                     <div id="teacherDeskContainerBottom" class="mt-2 min-h-[10px] flex items-center justify-center shrink-0"></div>
                     <div id="classroomObjectsContainerBottom" class="mt-2 min-h-[10px] flex items-center justify-center shrink-0"></div>
                 </div>

                 <!-- Legend -->
                 <div class="mt-2 flex flex-wrap gap-3 justify-center no-print border-t pt-2 text-[11px] text-gray-600 shrink-0">
                     <span class="font-bold">åœ–ä¾‹:</span>
                     <div class="flex items-center gap-1"><span class="w-2 h-2 bg-blue-100 border-l-2 border-blue-500 border-solid block"></span>ç”· (å¯¦ç·š)</div>
                     <div class="flex items-center gap-1"><span class="w-2 h-2 bg-pink-50 border-l-2 border-pink-500 border-dashed block"></span>å¥³ (è™›ç·š)</div>
                     <div class="flex items-center gap-1"><i class="fas fa-lock text-yellow-500"></i> é–å®š</div>
                     <div class="flex items-center gap-1"><i class="fas fa-comment-dots"></i> éœ€æ±‚</div>
                     <div class="flex items-center gap-1"><span class="w-2 h-2 border border-dashed border-gray-400 block"></span>ç©ºä½</div>
                 </div>
             </div>
        </div>
    </main>

    <!-- Draggable Mascot -->
    <img id="mascot" src="image/LiyuChillGuy.svg" alt="Mascot" class="no-print" draggable="false">

    <script>
        class ClassroomSeatingManager {
            constructor() {
                this.STORAGE_KEY = 'seating_chart_pro_data';
                this.historyStack = [];
                this.historyIndex = -1;
                this.MAX_HISTORY = 20;

                this.state = {
                    students: [], 
                    layoutMap: new Map(), 
                    lockedDeskIds: new Set(),
                    waitingBench: [],
                    groupNames: {},
                    seatingMode: 'traditional',
                    viewPerspective: 'teacher',
                    showBlackboard: false,
                    showTeacherDesk: false,
                    dragMode: 'swap',
                    // Display Options
                    showGenderColor: true,
                    showNeeds: true,
                    showGenderSymbol: true,
                    showEmptySeats: true,
                    showGroupNames: true,
                    showAnonymous: false,
                    includeBenchInShuffle: false,
                    className: '',
                    rows: 4,
                    cols: 6,
                    numGroups: 5,
                    studentsPerGroup: 4
                };
                this.sortableInstances = [];
                this.nextGroupId = 0;
                this.xlsx = XLSX;
                this.elements = this.getDOMElements();
                
                this.handleNativeDragStart = this.handleNativeDragStart.bind(this);
                this.handleNativeDragOver = this.handleNativeDragOver.bind(this);
                this.handleNativeDragLeave = this.handleNativeDragLeave.bind(this);
                this.handleNativeDrop = this.handleNativeDrop.bind(this);
                this.handleNativeDragEnd = this.handleNativeDragEnd.bind(this);
                this.currentDragSourceId = null;
                this.currentDragSourceType = null;

                this.bindEventListeners();
                this.initMascotDrag();
                
                if (this.loadFromLocalStorage()) {
                    this.saveStateToHistory(); 
                } else {
                    this.initializeDefault();
                    this.saveStateToHistory();
                }
                this.updateUndoRedoButtons();
            }

            getDOMElements() {
                return {
                    saveProjectBtn: document.getElementById('saveProjectBtn'),
                    loadProjectInput: document.getElementById('loadProjectInput'),
                    sequentialArrangeBtn: document.getElementById('sequentialArrangeBtn'),
                    randomizeBtn: document.getElementById('randomizeBtn'),
                    refreshStudentListBtn: document.getElementById('refreshStudentListBtn'),
                    clearLayoutBtn: document.getElementById('clearLayoutBtn'),
                    undoBtn: document.getElementById('undoBtn'),
                    redoBtn: document.getElementById('redoBtn'),
                    downloadTemplateBtn: document.getElementById('downloadTemplateBtn'),
                    exportLayoutBtn: document.getElementById('exportLayoutBtn'),
                    exportImageBtn: document.getElementById('exportImageBtn'),
                    perspectiveToggleBtn: document.getElementById('perspectiveToggleBtn'),
                    toggleBlackboardBtn: document.getElementById('toggleBlackboardBtn'),
                    toggleTeacherDeskBtn: document.getElementById('toggleTeacherDeskBtn'),
                    addGroupBtn: document.getElementById('addGroupBtn'),
                    excelFile: document.getElementById('excelFile'),
                    classNameInput: document.getElementById('classNameInput'),
                    rowsInput: document.getElementById('rows'),
                    colsInput: document.getElementById('cols'),
                    numGroupsInput: document.getElementById('numGroups'),
                    studentsPerGroupInput: document.getElementById('studentsPerGroup'),
                    studentsTextarea: document.getElementById('students'),
                    // Display Checkboxes
                    showGenderColorCheckbox: document.getElementById('showGenderColorCheckbox'),
                    showNeedsCheckbox: document.getElementById('showNeedsCheckbox'),
                    showGenderSymbolCheckbox: document.getElementById('showGenderSymbolCheckbox'),
                    showEmptySeatsCheckbox: document.getElementById('showEmptySeatsCheckbox'),
                    showGroupNamesCheckbox: document.getElementById('showGroupNamesCheckbox'),
                    showAnonymousCheckbox: document.getElementById('showAnonymousCheckbox'),
                    includeBenchInShuffle: document.getElementById('includeBenchInShuffle'),
                    
                    printClassName: document.getElementById('printClassName'),
                    webClassName: document.getElementById('webClassName'),
                    traditionalInputsDiv: document.getElementById('traditionalInputs'),
                    groupInputsDiv: document.getElementById('groupInputs'),
                    classroomLayout: document.getElementById('classroomLayout'),
                    seatingChart: document.getElementById('seatingChart'),
                    waitingBench: document.getElementById('waitingBench'),
                    classInfo: document.getElementById('classInfo'),
                    blackboardObject: document.getElementById('blackboardObject'),
                    teacherDeskObject: document.getElementById('teacherDeskObject'),
                    teacherDeskContainerTop: document.getElementById('teacherDeskContainerTop'),
                    teacherDeskContainerBottom: document.getElementById('teacherDeskContainerBottom'),
                    classroomObjectsContainerTop: document.getElementById('classroomObjectsContainerTop'),
                    classroomObjectsContainerBottom: document.getElementById('classroomObjectsContainerBottom'),
                    body: document.body,
                };
            }

            bindEventListeners() {
                this.elements.saveProjectBtn.addEventListener('click', () => this.saveProjectToFile());
                this.elements.loadProjectInput.addEventListener('change', (e) => this.loadProjectFromFile(e));
                
                this.elements.sequentialArrangeBtn.addEventListener('click', () => { this.saveStateToHistory(); this.arrangeSeats(false); });
                this.elements.randomizeBtn.addEventListener('click', () => { this.saveStateToHistory(); this.arrangeSeats(true); });
                this.elements.refreshStudentListBtn.addEventListener('click', () => { this.saveStateToHistory(); this.refreshStudentData(); });
                this.elements.clearLayoutBtn.addEventListener('click', () => { 
                    if(confirm('ç¢ºå®šè¦æ¸…ç©ºåº§ä½è¡¨å—ï¼Ÿæ‰€æœ‰å­¸ç”Ÿå°‡å›åˆ°æš«å­˜å€ã€‚')) { 
                        this.saveStateToHistory(); 
                        this.clearSeatingLayout(); 
                    } 
                });
                this.elements.undoBtn.addEventListener('click', () => this.undo());
                this.elements.redoBtn.addEventListener('click', () => this.redo());
                
                this.elements.downloadTemplateBtn.addEventListener('click', (e) => this.generateExcelTemplate(e));
                this.elements.excelFile.addEventListener('change', (e) => { this.saveStateToHistory(); this.importStudentsFromExcel(e); });
                this.elements.exportLayoutBtn.addEventListener('click', () => this.exportSeatingLayout());
                this.elements.exportImageBtn.addEventListener('click', () => this.exportLayoutImage());
                
                this.elements.perspectiveToggleBtn.addEventListener('click', () => { this.togglePerspective(); this.saveToLocalStorage(); });
                this.elements.toggleBlackboardBtn.addEventListener('click', () => { this.state.showBlackboard = !this.state.showBlackboard; this.updateUIState(); this.renderClassroomObjects(); this.saveToLocalStorage(); });
                this.elements.toggleTeacherDeskBtn.addEventListener('click', () => { this.state.showTeacherDesk = !this.state.showTeacherDesk; this.updateUIState(); this.renderClassroomObjects(); this.saveToLocalStorage(); });
                this.elements.includeBenchInShuffle.addEventListener('change', () => { this.state.includeBenchInShuffle = this.elements.includeBenchInShuffle.checked; this.saveToLocalStorage(); });
                
                // Display Toggles (Updates State & UI immediately)
                const bindToggle = (elem, key) => {
                    elem.addEventListener('change', () => {
                        this.state[key] = elem.checked;
                        this.updateDisplayOptions();
                        this.saveToLocalStorage();
                    });
                };
                bindToggle(this.elements.showGenderColorCheckbox, 'showGenderColor');
                bindToggle(this.elements.showNeedsCheckbox, 'showNeeds');
                bindToggle(this.elements.showGenderSymbolCheckbox, 'showGenderSymbol');
                bindToggle(this.elements.showEmptySeatsCheckbox, 'showEmptySeats');
                bindToggle(this.elements.showGroupNamesCheckbox, 'showGroupNames');
                bindToggle(this.elements.showAnonymousCheckbox, 'showAnonymous');
                
                this.elements.classNameInput.addEventListener('input', () => { this.updateClassName(); this.saveToLocalStorage(); });
                this.elements.studentsTextarea.addEventListener('change', () => this.saveToLocalStorage());
                this.elements.addGroupBtn.addEventListener('click', () => { this.saveStateToHistory(); this.addNewGroup(); this.saveToLocalStorage(); });
                
                document.querySelectorAll('input[name="seatingMode"]').forEach(radio => { 
                    radio.addEventListener('change', (e) => { 
                        this.saveStateToHistory();
                        this.handleModeChange(e.target.value); 
                    }); 
                });
                document.querySelectorAll('input[name="dragMode"]').forEach(radio => { 
                    radio.addEventListener('change', (e) => { 
                        this.state.dragMode = e.target.value; 
                        this.renderSeatingChart(); 
                        this.renderWaitingBench(); 
                        this.saveToLocalStorage(); 
                    }); 
                });
                
                [this.elements.rowsInput, this.elements.colsInput, this.elements.numGroupsInput, this.elements.studentsPerGroupInput].forEach(input => { 
                    input.addEventListener('change', () => { 
                        this.saveStateToHistory();
                        this.updateConfigFromInputsAndRender(); 
                        this.saveToLocalStorage(); 
                    }); 
                });
                
                this.elements.seatingChart.addEventListener('click', (e) => this.handleChartClicks(e));
                this.elements.waitingBench.addEventListener('click', (e) => this.handleChartClicks(e));
                
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); this.undo(); }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); this.redo(); }
                });
            }

            updateDisplayOptions() {
                const layout = this.elements.classroomLayout;
                
                // Toggle Classes based on state
                layout.classList.toggle('view-style-gender-color', this.state.showGenderColor);
                layout.classList.toggle('view-style-needs', this.state.showNeeds);
                layout.classList.toggle('view-style-gender-symbol', this.state.showGenderSymbol);
                layout.classList.toggle('view-style-hide-empty', !this.state.showEmptySeats);
                layout.classList.toggle('view-style-hide-group-names', !this.state.showGroupNames);
                layout.classList.toggle('view-style-anonymous', this.state.showAnonymous);
                
                // Special handling for empty groups hiding
                if (!this.state.showEmptySeats && this.state.seatingMode === 'group') {
                     document.querySelectorAll('.group-container').forEach(c => { 
                         const hasStudent = c.querySelector('.desk:not(.empty-seat)');
                         if(!hasStudent) c.classList.add('all-empty'); else c.classList.remove('all-empty');
                     });
                } else {
                    document.querySelectorAll('.group-container.all-empty').forEach(c => c.classList.remove('all-empty'));
                }
            }

            initializeDefault() {
                this.updateConditionalInputs();
                this.updateUIState();
                this.updateCheckboxInputs();
                this.updateDisplayOptions();
                this.arrangeSeats();
            }

            updateCheckboxInputs() {
                 this.elements.showGenderColorCheckbox.checked = this.state.showGenderColor;
                 this.elements.showNeedsCheckbox.checked = this.state.showNeeds;
                 this.elements.showGenderSymbolCheckbox.checked = this.state.showGenderSymbol;
                 this.elements.showEmptySeatsCheckbox.checked = this.state.showEmptySeats;
                 this.elements.showGroupNamesCheckbox.checked = this.state.showGroupNames;
                 this.elements.showAnonymousCheckbox.checked = this.state.showAnonymous;
                 this.elements.includeBenchInShuffle.checked = this.state.includeBenchInShuffle;
            }

            // ... (Drag & Drop Logic, History, Undo/Redo - Kept same as previous) ...
            saveStateToHistory() {
                const stateSnapshot = {
                    ...this.state,
                    layoutMap: Array.from(this.state.layoutMap.entries()),
                    lockedDeskIds: Array.from(this.state.lockedDeskIds),
                    waitingBench: JSON.parse(JSON.stringify(this.state.waitingBench)),
                    groupNames: JSON.parse(JSON.stringify(this.state.groupNames))
                };
                if (this.historyIndex < this.historyStack.length - 1) {
                    this.historyStack = this.historyStack.slice(0, this.historyIndex + 1);
                }
                this.historyStack.push(JSON.stringify(stateSnapshot));
                if (this.historyStack.length > this.MAX_HISTORY) this.historyStack.shift();
                else this.historyIndex++;
                this.updateUndoRedoButtons();
            }

            undo() { if (this.historyIndex > 0) { this.historyIndex--; this.restoreStateFromHistory(this.historyStack[this.historyIndex]); } }
            redo() { if (this.historyIndex < this.historyStack.length - 1) { this.historyIndex++; this.restoreStateFromHistory(this.historyStack[this.historyIndex]); } }

            restoreStateFromHistory(jsonString) {
                const s = JSON.parse(jsonString);
                this.state = { ...s, lockedDeskIds: new Set(s.lockedDeskIds), layoutMap: new Map(s.layoutMap) };
                this.elements.classNameInput.value = this.state.className;
                this.elements.rowsInput.value = this.state.rows;
                this.elements.colsInput.value = this.state.cols;
                this.elements.numGroupsInput.value = this.state.numGroups;
                this.elements.studentsPerGroupInput.value = this.state.studentsPerGroup;
                
                const modeRadio = document.querySelector(`input[name="seatingMode"][value="${this.state.seatingMode}"]`);
                if(modeRadio) modeRadio.checked = true;
                const dragRadio = document.querySelector(`input[name="dragMode"][value="${this.state.dragMode}"]`);
                if(dragRadio) dragRadio.checked = true;

                this.updateConditionalInputs();
                this.updateUIState();
                this.updateCheckboxInputs();
                this.renderSeatingChart();
                this.renderWaitingBench();
                this.updateDisplayOptions();
                this.saveToLocalStorage();
                this.updateUndoRedoButtons();
            }

            updateUndoRedoButtons() {
                this.elements.undoBtn.disabled = this.historyIndex <= 0;
                this.elements.redoBtn.disabled = this.historyIndex >= this.historyStack.length - 1;
            }

            // ... (Seat Arrangement Logic - Kept same) ...
            arrangeSeats(randomize = false) {
                const textStudents = this.parseStudents(this.elements.studentsTextarea.value);
                this.state.students = textStudents;
                const lockedAssignments = new Map();
                this.state.lockedDeskIds.forEach(deskId => {
                    const student = this.state.layoutMap.get(deskId);
                    if (student) {
                        const validStudent = textStudents.find(s => s.id === student.id || (s.number === student.number && s.name === student.name));
                        if (validStudent) lockedAssignments.set(deskId, validStudent);
                    }
                });
                let availableStudents = textStudents.filter(s => {
                    const isLocked = Array.from(lockedAssignments.values()).some(lockedS => lockedS.id === s.id);
                    return !isLocked;
                });
                if (!this.state.includeBenchInShuffle && randomize) {
                     availableStudents = availableStudents.filter(s => {
                         const isInBench = this.state.waitingBench.some(wbS => wbS.id === s.id || (wbS.number === s.number && wbS.name === s.name));
                         return !isInBench;
                     });
                } else {
                    this.state.waitingBench = []; 
                }
                if (randomize) availableStudents = this.shuffleArray(availableStudents);
                const allDeskIds = this.generateAllDeskIds();
                const newLayoutMap = new Map(lockedAssignments);
                let studentIndex = 0;
                allDeskIds.forEach(deskId => {
                    if (newLayoutMap.has(deskId)) return;
                    if (studentIndex < availableStudents.length) {
                        newLayoutMap.set(deskId, availableStudents[studentIndex++]);
                    }
                });
                while (studentIndex < availableStudents.length) {
                    this.state.waitingBench.push(availableStudents[studentIndex++]);
                }
                this.state.layoutMap = newLayoutMap;
                this.renderSeatingChart();
                this.renderWaitingBench();
                this.updateDisplayOptions(); // Ensure visual styles applied
                this.saveToLocalStorage();
            }

            // ... (Refresh, clear, drag logic - Kept same) ...
            refreshStudentData() {
                 const textStudents = this.parseStudents(this.elements.studentsTextarea.value);
                const newStudentMap = new Map(textStudents.map(s => [s.number + '_' + s.name, s]));
                this.state.layoutMap.forEach((student, deskId) => {
                    const key = student.number + '_' + student.name;
                    if (newStudentMap.has(key)) {
                        this.state.layoutMap.set(deskId, { ...student, ...newStudentMap.get(key), id: student.id });
                        newStudentMap.delete(key);
                    } else {
                        this.state.layoutMap.delete(deskId);
                        this.state.lockedDeskIds.delete(deskId);
                    }
                });
                this.state.waitingBench = this.state.waitingBench.filter(s => {
                    const key = s.number + '_' + s.name;
                    if (newStudentMap.has(key)) {
                        Object.assign(s, newStudentMap.get(key));
                        newStudentMap.delete(key);
                        return true;
                    }
                    return false;
                });
                const remainingStudents = Array.from(newStudentMap.values());
                const emptyDesks = this.getEmptyDeskIds();
                while (remainingStudents.length > 0 && emptyDesks.length > 0) {
                    this.state.layoutMap.set(emptyDesks.shift(), remainingStudents.shift());
                }
                remainingStudents.forEach(s => this.state.waitingBench.push(s));
                this.renderSeatingChart();
                this.renderWaitingBench();
                this.updateDisplayOptions();
                this.saveToLocalStorage();
            }
            
            clearSeatingLayout() {
                // Move everyone to bench
                this.state.layoutMap.forEach(s => this.state.waitingBench.push(s));
                this.state.layoutMap.clear();
                this.state.lockedDeskIds.clear();
                
                this.renderSeatingChart();
                this.renderWaitingBench();
                this.updateClassInfo(document.querySelectorAll('#seatingChart .desk').length);
                this.saveToLocalStorage();
            }

            getEmptyDeskIds() { const ids = []; document.querySelectorAll('#seatingChart .desk').forEach(desk => { const id = desk.dataset.deskId; if (id && !this.state.layoutMap.has(id)) ids.push(id); }); return ids; }
            generateAllDeskIds() { const ids = []; if (this.state.seatingMode === 'traditional') { for (let i = 0; i < this.state.rows; i++) { for (let j = 0; j < this.state.cols; j++) ids.push(`r${i}c${j}`); } } else { const groupsToGen = Math.max(this.state.numGroups, Object.keys(this.state.groupNames).length); for (let g = 0; g < groupsToGen; g++) { const gKey = `g${g}`; if (!this.state.groupNames[gKey]) this.state.groupNames[gKey] = `ç¬¬ ${g+1} çµ„`; for (let s = 0; s < this.state.studentsPerGroup; s++) ids.push(`${gKey}d${s}`); } } return ids; }

            // --- Rendering ---
            renderSeatingChart() {
                this.destroySortable();
                const seatingChart = this.elements.seatingChart;
                seatingChart.innerHTML = '';
                seatingChart.className = `transition-all min-h-[300px] rounded bg-white shadow-sm pb-8 mode-${this.state.seatingMode}`;
                let totalSlots = (this.state.seatingMode === 'traditional') ? this.renderTraditionalLayout() : this.renderGroupLayout();
                this.state.layoutMap.forEach((student, deskId) => {
                    const desk = seatingChart.querySelector(`.desk[data-desk-id="${deskId}"]`);
                    if (desk) this._updateDeskContent(desk, student);
                });
                this.renderClassroomObjects();
                this.updateClassInfo(totalSlots);
                if (this.state.seatingMode === 'group') this.initGroupSorting();
                if (this.state.dragMode === 'insert') this.initSortable(); else this.initNativeDrag();
                
                // Re-apply visual options after re-render
                this.updateDisplayOptions();
            }

            renderTraditionalLayout() {
                const chart = this.elements.seatingChart;
                chart.style.gridTemplateColumns = `repeat(${this.state.cols}, minmax(var(--desk-width), auto))`;
                const rowIndices = this.state.viewPerspective === 'teacher' ? Array.from({ length: this.state.rows }, (_, i) => i) : Array.from({ length: this.state.rows }, (_, i) => this.state.rows - 1 - i);
                const colIndices = this.state.viewPerspective === 'teacher' ? Array.from({ length: this.state.cols }, (_, j) => j) : Array.from({ length: this.state.cols }, (_, j) => this.state.cols - 1 - j);
                let count = 0;
                rowIndices.forEach(i => colIndices.forEach(j => { chart.appendChild(this.createDeskElement(`r${i}c${j}`, null)); count++; }));
                return count;
            }

            renderGroupLayout() {
                const chart = this.elements.seatingChart;
                chart.style.gridTemplateColumns = '';
                let maxG = this.state.numGroups - 1;
                this.state.layoutMap.forEach((_, k) => { if(k.startsWith('g')) { const gNum = parseInt(k.match(/g(\d+)/)[1]); if(gNum > maxG) maxG = gNum; } });
                const groupContainers = [];
                let totalDesks = 0;
                for (let i = 0; i <= maxG; i++) {
                    const gKey = `g${i}`;
                    const container = this.createGroupContainer(gKey, i);
                    let maxD = this.state.studentsPerGroup - 1;
                    this.state.layoutMap.forEach((_, k) => { if(k.startsWith(gKey + 'd')) { const dNum = parseInt(k.match(/d(\d+)/)[1]); if(dNum > maxD) maxD = dNum; } });
                    const desks = [];
                    for(let d=0; d<=maxD; d++) { desks.push(this.createDeskElement(`${gKey}d${d}`, null)); totalDesks++; }
                    if (this.state.viewPerspective === 'student') desks.reverse();
                    desks.forEach(d => container.appendChild(d));
                    groupContainers.push(container);
                }
                if(this.state.viewPerspective === 'student') groupContainers.reverse();
                groupContainers.forEach(g => chart.appendChild(g));
                return totalDesks;
            }

            renderWaitingBench() {
                const bench = this.elements.waitingBench;
                bench.innerHTML = '';
                this.state.waitingBench.forEach(student => {
                    const card = this.createDeskElement(null, student);
                    card.classList.add('w-auto', 'h-auto', 'min-h-[60px]', 'min-w-[80px]');
                    bench.appendChild(card);
                });
                if (this.state.dragMode === 'insert') {
                     this.sortableInstances.push(new Sortable(bench, { group: 'shared-desks', animation: 150, onEnd: (evt) => { this.saveStateToHistory(); this.handleSortableDrop(evt); } }));
                } else {
                    Array.from(bench.children).forEach(el => { this.attachNativeEvents(el); });
                    bench.addEventListener('dragover', this.handleNativeDragOver);
                    bench.addEventListener('dragleave', this.handleNativeDragLeave);
                    bench.addEventListener('drop', this.handleNativeDrop);
                }
            }

            createDeskElement(deskId, student) {
                const desk = document.createElement('div');
                desk.className = 'desk';
                if(deskId) desk.dataset.deskId = deskId;
                this._updateDeskContent(desk, student);
                return desk;
            }

            createGroupContainer(groupKey, index) {
                const div = document.createElement('div');
                div.className = 'group-container';
                div.dataset.groupKey = groupKey;
                const colors = ['#fca5a5','#fdba74','#fde047','#86efac','#93c5fd','#d8b4fe','#f9a8d4','#a7f3d0'];
                div.style.borderColor = colors[index % colors.length];
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'group-name-container';
                const nameSpan = document.createElement('span');
                nameSpan.className = 'group-name-display';
                const currentName = this.state.groupNames[groupKey] || `ç¬¬ ${index + 1} çµ„`;
                this.state.groupNames[groupKey] = currentName;
                nameSpan.textContent = currentName;
                const nameInput = document.createElement('input');
                nameInput.className = 'group-name-input';
                nameInput.value = currentName;
                nameInput.addEventListener('blur', (e) => { this.saveStateToHistory(); this.handleGroupNameEditEnd(e.target); });
                nameInput.addEventListener('keydown', (e) => { if(e.key==='Enter') e.target.blur(); });
                nameDiv.append(nameSpan, nameInput);
                const delBtn = document.createElement('div');
                delBtn.className = 'delete-group-btn';
                delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                div.append(nameDiv, delBtn);
                return div;
            }

            anonymizeName(name) {
                if (!name || name.length < 2) return name;
                if (name.length === 2) return name[0] + 'O';
                const mid = Math.floor(name.length / 2);
                return name.substring(0, mid) + 'O' + name.substring(mid + 1);
            }

            _updateDeskContent(desk, student) {
                desk.innerHTML = '';
                desk.classList.remove('empty-seat', 'male', 'female', 'is-locked');
                delete desk.dataset.studentId;
                const lockBtn = document.createElement('div');
                lockBtn.className = 'lock-btn';
                lockBtn.innerHTML = '<i class="fas fa-lock-open"></i>';
                
                if (student) {
                    desk.dataset.studentId = student.id;
                    if (student.gender === 'ç”·') desk.classList.add('male');
                    if (student.gender === 'å¥³') desk.classList.add('female');
                    const info = document.createElement('div');
                    info.className = 'student-info';
                    
                    const anonName = this.anonymizeName(student.name);

                    info.innerHTML = `
                        <div class="student-name-line" title="${student.number} ${student.name}">
                            ${student.number} 
                            <span class="name-full">${student.name}</span>
                            <span class="name-anon">${anonName}</span>
                            <span class="gender-symbol">${student.gender==='ç”·'?'â™‚':student.gender==='å¥³'?'â™€':''}</span>
                        </div>
                        <div class="desk-needs-display">${student.needs || ''}</div>
                    `;
                    desk.appendChild(lockBtn);
                    desk.appendChild(info);
                    if (desk.dataset.deskId && this.state.lockedDeskIds.has(desk.dataset.deskId)) {
                        desk.classList.add('is-locked');
                        lockBtn.querySelector('i').className = 'fas fa-lock';
                    }
                    if (student.needs) {
                        const needsIcon = document.createElement('span');
                        needsIcon.className = 'needs-icon';
                        needsIcon.innerHTML = `<i class="fas fa-comment-dots"></i><span class="tooltip">${student.needs}</span>`;
                        desk.appendChild(needsIcon);
                    }
                } else {
                    desk.classList.add('empty-seat');
                    desk.innerHTML = '<span class="text-gray-300 text-xs">ç©ºä½</span>';
                    if (this.state.seatingMode === 'group') {
                        const delSeat = document.createElement('div');
                        delSeat.className = 'delete-seat-btn';
                        delSeat.innerText = 'Ã—';
                        desk.appendChild(delSeat);
                    }
                }
            }

            handleChartClicks(e) {
                // Handle Lock
                if (e.target.closest('.lock-btn')) {
                    const desk = e.target.closest('.desk');
                    if (desk && desk.dataset.deskId && desk.dataset.studentId) {
                        this.saveStateToHistory();
                        const deskId = desk.dataset.deskId;
                        if (this.state.lockedDeskIds.has(deskId)) {
                            this.state.lockedDeskIds.delete(deskId);
                        } else {
                            this.state.lockedDeskIds.add(deskId);
                        }
                        this.renderSeatingChart();
                        this.saveToLocalStorage();
                    }
                    return;
                }
                
                // Handle Delete Seat
                if (e.target.closest('.delete-seat-btn')) {
                    this.saveStateToHistory();
                    this.handleDeleteSeat(e.target.closest('.delete-seat-btn'));
                    return;
                }
                
                // Handle Delete Group
                if (e.target.closest('.delete-group-btn')) {
                    if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å°çµ„å—ï¼Ÿçµ„å“¡æœƒå›åˆ°æš«å­˜å€ã€‚')) {
                        this.saveStateToHistory();
                        this.handleDeleteGroup(e.target.closest('.delete-group-btn'));
                    }
                    return;
                }

                // Handle Group Name Edit
                if (e.target.closest('.group-name-display')) {
                    this.saveStateToHistory();
                    this.handleGroupNameEditStart(e.target.closest('.group-name-display'));
                    return;
                }
            }
            
            // ... (Drag logic - same as before) ...
            destroySortable() { this.sortableInstances.forEach(s => s.destroy()); this.sortableInstances = []; }
            initSortable() { const options = { group: 'shared-desks', animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', dragClass: 'sortable-drag', onEnd: (evt) => { this.saveStateToHistory(); this.handleSortableDrop(evt); } }; if (this.state.seatingMode === 'traditional') { this.sortableInstances.push(new Sortable(this.elements.seatingChart, options)); } else { this.elements.seatingChart.querySelectorAll('.group-container').forEach(el => { this.sortableInstances.push(new Sortable(el, options)); }); } }
            initGroupSorting() { this.sortableInstances.push(new Sortable(this.elements.seatingChart, { animation: 150, filter: '.desk', preventOnFilter: false, ghostClass: 'sortable-ghost', onEnd: () => { this.saveStateToHistory(); this.updateLayoutFromDOM(); this.saveToLocalStorage(); } })); }
            handleSortableDrop(evt) { this.updateLayoutFromDOM(); this.saveToLocalStorage(); }
            initNativeDrag() { document.querySelectorAll('#seatingChart .desk').forEach(desk => { this.attachNativeEvents(desk); }); }
            attachNativeEvents(element) { const hasStudent = !!element.dataset.studentId; const isLocked = element.classList.contains('is-locked'); if (hasStudent && !isLocked) { element.setAttribute('draggable', 'true'); element.addEventListener('dragstart', this.handleNativeDragStart); element.addEventListener('dragend', this.handleNativeDragEnd); } else { element.removeAttribute('draggable'); } element.addEventListener('dragover', this.handleNativeDragOver); element.addEventListener('dragleave', this.handleNativeDragLeave); element.addEventListener('drop', this.handleNativeDrop); }
            handleNativeDragStart(e) { this.currentDragSourceType = e.target.closest('#waitingBench') ? 'bench' : 'desk'; this.currentDragSourceId = this.currentDragSourceType === 'bench' ? e.target.dataset.studentId : e.target.dataset.deskId; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', JSON.stringify({ type: this.currentDragSourceType, id: this.currentDragSourceId })); e.target.classList.add('is-dragging-source'); }
            handleNativeDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; const target = e.target.closest('.desk') || e.target.closest('#waitingBench'); if (target && !target.classList.contains('is-dragging-source')) { target.classList.add('drag-over-target'); } }
            handleNativeDragLeave(e) { const target = e.target.closest('.desk') || e.target.closest('#waitingBench'); if (target) target.classList.remove('drag-over-target'); }
            handleNativeDragEnd(e) { e.target.classList.remove('is-dragging-source'); document.querySelectorAll('.drag-over-target').forEach(el => el.classList.remove('drag-over-target')); }
            handleNativeDrop(e) { e.preventDefault(); this.saveStateToHistory(); const sourceData = JSON.parse(e.dataTransfer.getData('text/plain')); const targetElement = e.target.closest('.desk') || e.target.closest('#waitingBench'); if (!targetElement) return; let sourceStudent = null; if (sourceData.type === 'bench') sourceStudent = this.state.students.find(s => s.id === sourceData.id); else sourceStudent = this.state.layoutMap.get(sourceData.id); if (!sourceStudent) return; const isTargetBench = targetElement.id === 'waitingBench' || targetElement.closest('#waitingBench'); if (isTargetBench) { if (sourceData.type === 'desk') { this.state.waitingBench.push(sourceStudent); this.state.layoutMap.delete(sourceData.id); } } else { const targetDeskId = targetElement.dataset.deskId; if (!targetDeskId || this.state.lockedDeskIds.has(targetDeskId)) return; const targetStudent = this.state.layoutMap.get(targetDeskId); this.state.layoutMap.set(targetDeskId, sourceStudent); if (sourceData.type === 'bench') { this.state.waitingBench = this.state.waitingBench.filter(s => s.id !== sourceStudent.id); if (targetStudent) this.state.waitingBench.push(targetStudent); } else { if (targetStudent) this.state.layoutMap.set(sourceData.id, targetStudent); else this.state.layoutMap.delete(sourceData.id); } } this.renderSeatingChart(); this.renderWaitingBench(); this.saveToLocalStorage(); }

            // ... (Layout updates - same) ...
            updateLayoutFromDOM() { const newLayoutMap = new Map(); const newWaitingBench = []; const studentLookup = new Map(this.state.students.map(s => [s.id, s])); const processContainer = (container, generateIdFn) => { const domDesks = Array.from(container.querySelectorAll('.desk')); domDesks.forEach((desk, idx) => { const studentId = desk.dataset.studentId; const fixedDeskId = generateIdFn(idx); if (fixedDeskId && studentId && studentLookup.has(studentId)) { newLayoutMap.set(fixedDeskId, studentLookup.get(studentId)); } }); }; if (this.state.seatingMode === 'traditional') { const ids = []; const rowIndices = this.state.viewPerspective === 'teacher' ? Array.from({ length: this.state.rows }, (_, i) => i) : Array.from({ length: this.state.rows }, (_, i) => this.state.rows - 1 - i); const colIndices = this.state.viewPerspective === 'teacher' ? Array.from({ length: this.state.cols }, (_, j) => j) : Array.from({ length: this.state.cols }, (_, j) => this.state.cols - 1 - j); rowIndices.forEach(i => colIndices.forEach(j => ids.push(`r${i}c${j}`))); processContainer(this.elements.seatingChart, (i) => ids[i]); } else { const groupContainers = this.elements.seatingChart.querySelectorAll('.group-container'); groupContainers.forEach(container => { const gKey = container.dataset.groupKey; processContainer(container, (i) => { let slotIdx = i; if (this.state.viewPerspective === 'student') slotIdx = (this.state.studentsPerGroup - 1) - i; if (slotIdx >= 0 && slotIdx < this.state.studentsPerGroup) return `${gKey}d${slotIdx}`; return null; }); }); } const benchElements = document.querySelectorAll('#waitingBench .desk'); benchElements.forEach(el => { const sId = el.dataset.studentId; if(sId && studentLookup.has(sId)) newWaitingBench.push(studentLookup.get(sId)); }); this.state.layoutMap = newLayoutMap; this.state.waitingBench = newWaitingBench; this.updateClassInfo(document.querySelectorAll('#seatingChart .desk').length); }
            saveToLocalStorage() { const data = { state: { ...this.state, lockedDeskIds: Array.from(this.state.lockedDeskIds), layoutMap: Array.from(this.state.layoutMap.entries()) }, studentText: this.elements.studentsTextarea.value }; localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data)); }
            loadFromLocalStorage() { const raw = localStorage.getItem(this.STORAGE_KEY); if (!raw) return false; try { const data = JSON.parse(raw); this.restoreState(data); return true; } catch (e) { return false; } }
            restoreState(data) { const s = data.state; this.state = { ...s, lockedDeskIds: new Set(s.lockedDeskIds), layoutMap: new Map(s.layoutMap) }; this.elements.studentsTextarea.value = data.studentText; this.elements.classNameInput.value = this.state.className; this.elements.rowsInput.value = this.state.rows; this.elements.colsInput.value = this.state.cols; this.elements.numGroupsInput.value = this.state.numGroups; this.elements.studentsPerGroupInput.value = this.state.studentsPerGroup; const modeRadio = document.querySelector(`input[name="seatingMode"][value="${this.state.seatingMode}"]`); if(modeRadio) modeRadio.checked = true; const dragRadio = document.querySelector(`input[name="dragMode"][value="${this.state.dragMode}"]`); if(dragRadio) dragRadio.checked = true; this.updateConditionalInputs(); this.updateUIState(); this.updateCheckboxInputs(); this.renderSeatingChart(); this.renderWaitingBench(); this.updateDisplayOptions(); this.saveToLocalStorage(); }
            
            // --- NEW: Save Project to File ---
            saveProjectToFile() {
                const data = { 
                    state: { 
                        ...this.state, 
                        lockedDeskIds: Array.from(this.state.lockedDeskIds), 
                        layoutMap: Array.from(this.state.layoutMap.entries()) 
                    }, 
                    studentText: this.elements.studentsTextarea.value,
                    version: '1.0'
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json;charset=utf-8"});
                saveAs(blob, `${this.state.className || 'æ•™å®¤åº§ä½å°ˆæ¡ˆ'}.json`);
            }

            // --- NEW: Load Project from File ---
            loadProjectFromFile(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = JSON.parse(evt.target.result);
                        this.restoreState(data);
                        this.saveStateToHistory();
                        alert('å°ˆæ¡ˆè®€å–æˆåŠŸï¼');
                    } catch (err) {
                        console.error(err);
                        alert('è®€å–å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                    }
                    e.target.value = ''; // Reset input
                };
                reader.readAsText(file);
            }

            // ... (Helpers - same) ...
            parseStudents(text) { const list = []; text.split('\n').forEach(line => { const parts = line.trim().split(/\s+/); if (parts.length >= 2) { const num = parts[0]; const name = parts[1]; const genderRaw = parts[2] ? parts[2].toLowerCase() : ''; const gender = (['ç”·','m'].includes(genderRaw)) ? 'ç”·' : (['å¥³','f'].includes(genderRaw)) ? 'å¥³' : 'å…¶ä»–'; const needs = parts.slice(3).join(' '); const id = `s_${num}_${name}`; list.push({ id, number: num, name, gender, needs }); } }); return list; }
            shuffleArray(array) { const newArr = [...array]; for (let i = newArr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [newArr[i], newArr[j]] = [newArr[j], newArr[i]]; } return newArr; }
            updateClassName() { this.state.className = this.elements.classNameInput.value.trim(); this.elements.webClassName.textContent = this.state.className; this.elements.printClassName.textContent = this.state.className || 'åº§ä½è¡¨'; }
            updateConditionalInputs() { const isTrad = this.state.seatingMode === 'traditional'; this.elements.traditionalInputsDiv.classList.toggle('hidden', !isTrad); this.elements.groupInputsDiv.classList.toggle('hidden', isTrad); this.elements.addGroupBtn.classList.toggle('hidden', isTrad); }
            updateUIState() { this.elements.perspectiveToggleBtn.innerHTML = `<i class="fas fa-sync-alt mr-1"></i> ${this.state.viewPerspective==='teacher'?'è€å¸«è¦–è§’':'å­¸ç”Ÿè¦–è§’'}`; const bbIcon = this.state.showBlackboard ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>'; const tdIcon = this.state.showTeacherDesk ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>'; this.elements.toggleBlackboardBtn.innerHTML = `${bbIcon} é»‘æ¿`; this.elements.toggleTeacherDeskBtn.innerHTML = `${tdIcon} è¬›æ¡Œ`; this.elements.blackboardObject.classList.toggle('hidden', !this.state.showBlackboard); this.elements.teacherDeskObject.classList.toggle('hidden', !this.state.showTeacherDesk); this.updateClassInfo(this.state.layoutMap.size + this.getEmptyDeskIds().length); }
            updateClassInfo(total) { const assigned = this.state.layoutMap.size; const bench = this.state.waitingBench.length; this.elements.classInfo.innerHTML = `åº§ä½: ${total} | å·²æ’: ${assigned} | ç©ºä½: ${Math.max(0, total - assigned)} | æš«å­˜å€: ${bench}`; }
            renderClassroomObjects() { const topDiv = this.elements.classroomObjectsContainerTop; const botDiv = this.elements.classroomObjectsContainerBottom; const tdTop = this.elements.teacherDeskContainerTop; const tdBot = this.elements.teacherDeskContainerBottom; topDiv.innerHTML = ''; botDiv.innerHTML = ''; tdTop.innerHTML = ''; tdBot.innerHTML = ''; const bb = this.elements.blackboardObject; const td = this.elements.teacherDeskObject; if (this.state.viewPerspective === 'teacher') { if (this.state.showBlackboard) topDiv.appendChild(bb); if (this.state.showTeacherDesk) tdTop.appendChild(td); } else { if (this.state.showBlackboard) botDiv.appendChild(bb); if (this.state.showTeacherDesk) tdBot.appendChild(td); } }
            handleModeChange(mode) { const currentGridStudents = []; this.state.layoutMap.forEach(s => currentGridStudents.push(s)); this.state.seatingMode = mode; this.updateConditionalInputs(); this.state.layoutMap.clear(); this.state.lockedDeskIds.clear(); const newDeskIds = this.generateAllDeskIds(); let sIdx = 0; newDeskIds.forEach(id => { if (sIdx < currentGridStudents.length) { this.state.layoutMap.set(id, currentGridStudents[sIdx++]); } }); while(sIdx < currentGridStudents.length) { this.state.waitingBench.push(currentGridStudents[sIdx++]); } this.renderSeatingChart(); this.renderWaitingBench(); this.saveToLocalStorage(); }
            updateConfigFromInputsAndRender() { this.state.rows = parseInt(this.elements.rowsInput.value); this.state.cols = parseInt(this.elements.colsInput.value); this.state.numGroups = parseInt(this.elements.numGroupsInput.value); this.state.studentsPerGroup = parseInt(this.elements.studentsPerGroupInput.value); this.arrangeSeats(); }
            togglePerspective() { this.state.viewPerspective = this.state.viewPerspective === 'teacher' ? 'student' : 'teacher'; this.updateUIState(); this.renderSeatingChart(); }
            addNewGroup() { if(this.state.seatingMode !== 'group') return; const gIdx = this.nextGroupId++; const gKey = `g${gIdx}`; this.state.groupNames[gKey] = `æ–°å°çµ„ ${gIdx+1}`; const container = this.createGroupContainer(gKey, gIdx); for(let i=0; i<this.state.studentsPerGroup; i++) container.appendChild(this.createDeskElement(`${gKey}d${i}`, null)); const chart = this.elements.seatingChart; if(this.state.viewPerspective === 'student') chart.prepend(container); else chart.appendChild(container); if(this.state.seatingMode === 'group') this.initGroupSorting(); if(this.state.dragMode === 'insert') this.initSortable(); else this.initNativeDrag(); }
            handleDeleteSeat(btn) { const desk = btn.closest('.desk'); const id = desk.dataset.deskId; if(id) { this.state.layoutMap.delete(id); this.state.lockedDeskIds.delete(id); } desk.remove(); if(this.state.dragMode === 'insert') this.updateLayoutFromDOM(); this.saveToLocalStorage(); }
            handleDeleteGroup(btn) { const group = btn.closest('.group-container'); const key = group.dataset.groupKey; group.querySelectorAll('.desk').forEach(d => { const sid = d.dataset.studentId; if(sid) { const s = this.state.students.find(x=>x.id===sid); if(s) this.state.waitingBench.push(s); } }); delete this.state.groupNames[key]; group.remove(); if(this.state.dragMode === 'insert') this.updateLayoutFromDOM(); this.renderWaitingBench(); this.saveToLocalStorage(); }
            handleGroupNameEditStart(el) { const input = el.nextElementSibling; el.classList.add('editing'); input.classList.add('editing'); input.focus(); }
            handleGroupNameEditEnd(input) { const display = input.previousElementSibling; const group = input.closest('.group-container'); const key = group.dataset.groupKey; this.state.groupNames[key] = input.value; display.textContent = input.value; input.classList.remove('editing'); display.classList.remove('editing'); this.saveToLocalStorage(); }
            
            // --- EXPORT TO IMAGE ---
            async exportLayoutImage() {
                const layoutDiv = this.elements.classroomLayout;
                this.elements.classInfo.style.display = 'none'; // Hide Status
                this.elements.printClassName.textContent = this.state.className || 'åº§ä½è¡¨'; 
                this.elements.printClassName.classList.remove('hidden');
                this.elements.webClassName.style.display = 'none';
                
                const trashBtns = document.querySelectorAll('.delete-seat-btn, .delete-group-btn');
                trashBtns.forEach(btn => btn.style.display = 'none');

                try {
                    const canvas = await html2canvas(layoutDiv, {
                        scale: 2, 
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        ignoreElements: (node) => node.classList.contains('no-print') 
                    });
                    
                    canvas.toBlob((blob) => {
                        saveAs(blob, `${this.state.className || 'åº§ä½è¡¨'}.png`);
                    });
                } catch (err) {
                    console.error("Export failed", err);
                    alert("åŒ¯å‡ºåœ–ç‰‡å¤±æ•—ï¼Œè«‹é‡è©¦");
                } finally {
                    this.elements.classInfo.style.display = ''; 
                    this.elements.printClassName.classList.add('hidden');
                    this.elements.webClassName.style.display = '';
                    trashBtns.forEach(btn => btn.style.display = '');
                }
            }

            // --- EXPORT TO WORD ---
            async exportSeatingLayout() {
                if(this.state.dragMode === 'insert') this.updateLayoutFromDOM();

                const { Document, Packer, Paragraph, Table, TableCell, TableRow, WidthType, HeadingLevel, AlignmentType } = docx;

                const title = new Paragraph({
                    text: this.state.className || "æ•™å®¤åº§ä½è¡¨",
                    heading: HeadingLevel.HEADING_1,
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 300 }
                });

                const info = new Paragraph({
                    text: `åŒ¯å‡ºæ™‚é–“: ${new Date().toLocaleString()}`,
                    alignment: AlignmentType.RIGHT,
                    spacing: { after: 200 }
                });

                // Helper to format student text based on settings
                const getStudentText = (student) => {
                    if (!student) return "";
                    let name = student.name;
                    if (this.state.showAnonymous) name = this.anonymizeName(name);
                    let text = `${student.number} ${name}`;
                    if (this.state.showGenderSymbol) text += (student.gender==='ç”·' ? ' â™‚' : student.gender==='å¥³' ? ' â™€' : '');
                    if (this.state.showNeeds && student.needs) text += `\n(${student.needs})`;
                    return text;
                };

                let contentTable;

                if (this.state.seatingMode === 'traditional') {
                    const rows = [];
                    for (let i = 0; i < this.state.rows; i++) {
                        const cells = [];
                        for (let j = 0; j < this.state.cols; j++) {
                            const s = this.state.layoutMap.get(`r${i}c${j}`);
                            const cellText = getStudentText(s);
                            cells.push(new TableCell({
                                children: [new Paragraph({ text: cellText, alignment: AlignmentType.CENTER })],
                                width: { size: 100 / this.state.cols, type: WidthType.PERCENTAGE },
                                verticalAlign: "center",
                                height: { value: 1000, rule: "atLeast" }
                            }));
                        }
                        rows.push(new TableRow({ children: cells }));
                    }
                    contentTable = new Table({
                        rows: rows,
                        width: { size: 100, type: WidthType.PERCENTAGE }
                    });
                } else {
                    const rows = [];
                    // Group Header
                    rows.push(new TableRow({
                        children: [
                            new TableCell({ children: [new Paragraph({text: "å°çµ„åç¨±", bold: true})], width: {size: 30, type: WidthType.PERCENTAGE} }),
                            new TableCell({ children: [new Paragraph({text: "æˆå“¡", bold: true})], width: {size: 70, type: WidthType.PERCENTAGE} })
                        ]
                    }));

                    const groups = document.querySelectorAll('.group-container');
                    groups.forEach(g => {
                        const name = g.querySelector('.group-name-display').textContent;
                        const students = [];
                        g.querySelectorAll('.desk').forEach(d => {
                            const sid = d.dataset.studentId;
                            if(sid) {
                                const s = this.state.students.find(x => x.id === sid);
                                if(s) students.push(getStudentText(s).replace('\n', ' '));
                            }
                        });
                        
                        // Only add group if not hidden via empty settings
                        if (!this.state.showEmptySeats && students.length === 0) return;

                        rows.push(new TableRow({
                            children: [
                                new TableCell({ children: [new Paragraph(name)] }),
                                new TableCell({ children: [new Paragraph(students.join(', '))] })
                            ]
                        }));
                    });

                    contentTable = new Table({
                        rows: rows,
                        width: { size: 100, type: WidthType.PERCENTAGE }
                    });
                }

                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: [title, info, contentTable],
                    }],
                });

                const blob = await Packer.toBlob(doc);
                saveAs(blob, `${this.state.className || 'åº§ä½è¡¨'}.docx`);
            }

            generateExcelTemplate(e) { e.preventDefault(); const wb = this.xlsx.utils.book_new(); const wsData = [ ['åº§è™Ÿ', 'å§“å', 'æ€§åˆ¥', 'éœ€æ±‚'], ['1', 'å…¬å°æ°‘', 'ç”·', 'éœ€è¦æé†’'], ['2', 'é‚±å°ç‘œ', 'å¥³', 'æ²‰ç™®AIç„¡æ³•è‡ªæ‹”'], ['3', 'é™³å¤§å¾·', 'M', ''], ['4', 'æ—ç¾ç››', 'F', 'è¦–åŠ›ä¸å¥½'], ['5', 'ç‹å°ä¿', 'F', ''] ]; const ws = this.xlsx.utils.aoa_to_sheet(wsData); ws['!cols'] = [ { wch: 8 }, { wch: 12 }, { wch: 6 }, { wch: 25 } ]; this.xlsx.utils.book_append_sheet(wb, ws, 'å­¸ç”Ÿåå–®'); this.xlsx.writeFile(wb, 'å­¸ç”Ÿåå–®ç¯„æœ¬.xlsx'); }
            importStudentsFromExcel(e) {
                const file = e.target.files[0]; if(!file) return; const reader = new FileReader();
                reader.onload = (evt) => {
                    const workbook = this.xlsx.read(evt.target.result, {type:'binary'}); const sheet = workbook.Sheets[workbook.SheetNames[0]]; const json = this.xlsx.utils.sheet_to_json(sheet, {header:1});
                    let txt = "";
                    for(let i=1; i<json.length; i++) { const row = json[i]; if(row[0] && row[1]) txt += `${row[0]} ${row[1]} ${row[2]||''} ${row[3]||''}\n`; }
                    this.elements.studentsTextarea.value = txt; this.saveToLocalStorage(); alert('åŒ¯å…¥å®Œæˆï¼Œè«‹é»æ“Šã€Œåˆ·æ–°åå–®ã€');
                }; reader.readAsBinaryString(file);
            }
            initMascotDrag() {
                const mascot = document.getElementById('mascot');
                let isDragging = false; let currentX; let currentY; let initialX; let initialY; let xOffset = 0; let yOffset = 0;
                const dragStart = (e) => { initialX = e.clientX - xOffset; initialY = e.clientY - yOffset; if (e.target === mascot) isDragging = true; };
                const dragEnd = (e) => { initialX = currentX; initialY = currentY; isDragging = false; this.saveToLocalStorage(); };
                const drag = (e) => { if (isDragging) { e.preventDefault(); currentX = e.clientX - initialX; currentY = e.clientY - initialY; xOffset = currentX; yOffset = currentY; mascot.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`; } };
                mascot.addEventListener("mousedown", dragStart); document.addEventListener("mouseup", dragEnd); document.addEventListener("mousemove", drag);
                mascot.addEventListener('click', (e) => {
                   if(!isDragging) { for(let i=0; i<15; i++) { const p = document.createElement('div'); p.className = 'particle'; p.style.backgroundColor = `hsl(${Math.random()*360}, 70%, 50%)`; p.style.left = e.clientX + 'px'; p.style.top = e.clientY + 'px'; document.body.appendChild(p); const angle = Math.random() * Math.PI * 2; const velocity = Math.random() * 100 + 50; const tx = Math.cos(angle) * velocity; const ty = Math.sin(angle) * velocity; requestAnimationFrame(() => { p.style.transform = `translate(${tx}px, ${ty}px) scale(0)`; p.style.opacity = 0; }); setTimeout(()=>p.remove(), 1000); } }
                });
            }
        }
        document.addEventListener('DOMContentLoaded', () => { window.app = new ClassroomSeatingManager(); });
    </script>
<footer class="bg-gray-800 text-white py-3 no-print mt-auto">
        <div class="container mx-auto px-4 text-center text-xs">
            <p>Copyright Â© Liyuchiutiger Gongminshen</p>
        </div>
    </footer>
</body>
</html>