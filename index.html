<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教室座位神管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- XLSX Library -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        :root { --desk-min-height: 70px; --desk-width: 95px; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; font-size: 14px; }
        .desk { transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: grab; position: relative; border: 1px solid #cbd5e1; border-radius: 0.375rem; min-height: var(--desk-min-height); width: var(--desk-width); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0.3rem; box-sizing: border-box; margin: 3px; background-color: white; overflow: visible; user-select: none; }
        .desk:hover:not(.sortable-ghost):not(.sortable-drag) { transform: translateY(-2px); box-shadow: 0 6px 10px -3px rgba(0, 0, 0, 0.1); z-index: 10; }
        .desk.sortable-chosen { cursor: grabbing !important; }
        .desk.sortable-ghost { opacity: 0.4; background-color: #a5f3fc !important; border: 2px dashed #0891b2 !important; }
        .desk.sortable-drag { opacity: 0.7; box-shadow: 0 8px 12px -3px rgba(0, 0, 0, 0.2); z-index: 50 !important; }
        .classroom-object { background-color: #a8a29e; border: 2px solid #78716c; color: white; font-weight: 500; display: flex; align-items: center; justify-content: center; border-radius: 0.375rem; }
        .blackboard { height: 45px; font-size: 0.9em; }
        .teacher-desk-object { height: 35px; width: 90px; background-color: #7c3aed; border-color: #5b21b6; font-size: 0.9em; }
        #seatingChart.mode-traditional { display: grid; gap: 6px; justify-content: center; padding: 5px; }
        .mode-traditional .desk:not(.empty-seat) { border-color: #93c5fd; }
        .mode-traditional .empty-seat { background-color: #f8fafc; border-color: #e2e8f0; color: #94a3b8; cursor: grab; }
        #seatingChart.mode-group {
            display: flex;
            flex-wrap: wrap; 
            gap: 12px;
            justify-content: center;
            padding: 10px;
            align-items: flex-start;
        }
        .group-container { position: relative; border: 2px dashed #a1a1aa; padding: 5px; padding-top: 28px; border-radius: 0.5rem; display: grid; grid-template-columns: repeat(2, auto); gap: 2px; background-color: rgba(241, 245, 249, 0.6); align-content: start; min-height: 100px; cursor: move; width: fit-content; height: fit-content; margin: 5px; transition: box-shadow 0.2s ease; }
        .group-container.sortable-chosen { border-style: solid !important; border-color: #60a5fa !important; box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important; cursor: grabbing !important; }
        .group-container.sortable-ghost { opacity: 0.5 !important; background-color: #e0f2fe !important; border: 2px solid #3b82f6 !important; }
        .group-container.sortable-drag { z-index: 60 !important; }
        .mode-group .empty-seat { background-color: #f1f5f9; border-color: #e2e8f0; color: #94a3b8; cursor: grab; }
        .group-name-container { position: absolute; top: 3px; left: 5px; right: 25px; display: flex; align-items: center; height: 20px; }
        .group-name-display { font-size: 11px; font-weight: bold; color: #4b5563; padding: 1px 4px; border-radius: 3px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; background-color: rgba(255,255,255,0.6); transition: background-color 0.2s; min-height: 16px; }
        .group-name-display:hover { background-color: rgba(255,255,255,0.9); }
        .group-name-input { font-size: 11px; padding: 0px 3px; border: 1px solid #ccc; border-radius: 3px; width: 100%; height: 18px; box-sizing: border-box; outline: none; display: none; }
        .group-name-display.editing { display: none; }
        .group-name-input.editing { display: block; }
        .delete-seat-btn { position: absolute; top: 1px; right: 1px; width: 14px; height: 14px; background-color: #f87171; color: white; border-radius: 50%; font-size: 9px; line-height: 14px; text-align: center; cursor: pointer; opacity: 0; transition: opacity 0.2s, background-color 0.2s; z-index: 15; display: block; pointer-events: none; }
        .mode-group .empty-seat:hover .delete-seat-btn { opacity: 0.8; pointer-events: auto; }
        .delete-seat-btn:hover { background-color: #ef4444; opacity: 1; }
        .delete-group-btn { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background-color: #ef4444; color: white; border-radius: 3px; font-size: 10px; line-height: 18px; text-align: center; cursor: pointer; opacity: 0.7; transition: opacity 0.2s, background-color 0.2s; z-index: 25; display: flex; align-items: center; justify-content: center; }
        .delete-group-btn:hover { opacity: 1; background-color: #dc2626; }
        .gender-visible .male { border-left: 4px solid #60a5fa; background-color: #f0f9ff; }
        .gender-visible .female { border-left: 4px solid #f472b6; background-color: #fdf4ff; }
        .gender-symbol { font-size: 0.9em; margin-left: 3px; font-weight: bold; }
        .male .gender-symbol { color: #3b82f6; }
        .female .gender-symbol { color: #ec4899; }
        .needs-icon { position: absolute; top: 3px; right: 3px; font-size: 0.75rem; color: #64748b; background-color: rgba(255, 255, 255, 0.7); padding: 1px 2px; border-radius: 3px; z-index: 15; cursor: help; }
        .tooltip { visibility: hidden; width: max-content; max-width: 140px; background-color: #334155; color: #fff; text-align: center; border-radius: 4px; padding: 4px 7px; position: absolute; z-index: 99; bottom: 105%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; font-size: 0.7rem; white-space: normal; word-wrap: break-word; pointer-events: none; }
        .needs-icon:hover .tooltip { visibility: visible; opacity: 1; }
        .student-info { display: flex; flex-direction: column; align-items: center; width: 100%; text-align: center; }
        .student-name-line { font-semibold text-gray-800 truncate; width: 100%; margin-bottom: 1px;}
        .desk-needs-print { display: none; font-size: 0.65rem; color: #475569; margin-top: 1px; text-align: center; width: 100%; word-wrap: break-word; }
        .controls-section { padding: 1rem; }
        .controls-section h2 { margin-bottom: 0.75rem; }
        .controls-section .grid { margin-bottom: 1rem; }
        @media (min-width: 1024px) { #controls-column { max-height: calc(100vh - 70px - 50px); overflow-y: auto; scrollbar-width: thin; } }

        /* --- NEW: Mascot Styles --- */
        #mascot {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 120px;
            height: auto;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 999;
        }
        #mascot:hover {
            transform: scale(1.15) rotate(-8deg);
            animation: mascot-shake 0.5s infinite alternate;
        }
        .particle {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1001; /* Above other elements */
            transition: transform 1s ease-out, opacity 1s ease-out;
        }
        @keyframes mascot-shake {
            0% { transform: scale(1.15) rotate(-8deg); }
            100% { transform: scale(1.15) rotate(8deg); }
        }
        @media (max-width: 768px) {
            #mascot {
                width: 80px;
                bottom: 15px;
                left: 15px;
            }
        }

        @media print {
            .no-print { display: none !important; }
            body { background-color: white; font-size: 9pt; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #preview-column { grid-column: span 3 / span 3 !important; }
            #classroomLayout { padding: 0; margin: 0; box-shadow: none; border: none; background-color: white !important; }
            #seatingChartWrapper { overflow: visible !important; }
            #seatingChart { gap: 2px !important; background-color: white !important; box-shadow: none !important; flex-wrap: wrap !important; }
            .desk { break-inside: avoid; box-shadow: none !important; border: 1px solid #666 !important; min-height: 55px !important; width: 75px !important; margin: 1px !important; padding: 0.2rem !important; font-size: 0.65rem !important; overflow: hidden !important; background-color: white !important; }
            .classroom-object { border: 1px solid #000 !important; height: 30px !important; background-color: #ccc !important; color: #000 !important;}
            .blackboard { height: 40px !important; }
            .group-container { border: 1px solid #999 !important; padding: 2px !important; padding-top: 18px !important; gap: 1px !important; display: grid !important; grid-template-columns: repeat(2, auto) !important; width: auto !important; height: auto !important; break-inside: avoid !important; background-color: white !important; margin: 1px !important; }
            .group-name-container { top: 1px !important; left: 2px !important; right: 2px !important; }
            .group-name-display { font-size: 8pt !important; background: none !important; cursor: default !important; font-weight: bold; color: #000 !important;}
            .group-name-input { display: none !important; }
            .delete-seat-btn, .delete-group-btn { display: none !important; }
            .tooltip, .gender-symbol { display: none !important; }
            .needs-icon { display: none !important; }
            .desk-needs-print { display: block !important; color: #000 !important; margin-top: 1px !important; }
            #printClassName { display: block !important; text-align: center; font-size: 1.5em; font-weight: bold; margin-bottom: 1em; }
            #webClassName { display: none !important; }
            .student-name-line { font-size: 0.8rem; }
            .print-hide-needs .desk-needs-print { display: none !important; }
            .print-hide-empty .empty-seat { visibility: hidden !important; border-color: transparent !important; background-color: transparent !important; }
            .print-hide-empty .group-container.print-empty-group { display: none !important; }
            .male { border-left: 3px solid #000 !important; background-color: #fff !important; }
            .female { border-left: 3px dotted #000 !important; background-color: #fff !important; }
            .print-hide-gender .male, .print-hide-gender .female { border-left: none !important; }
            .print-hide-group-names .group-name-container { display: none !important; }
            .print-hide-group-names .group-container { padding-top: 2px !important; }
         }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white py-5 shadow-lg no-print">
        <div class="container mx-auto px-4">
            <h1 class="text-2xl md:text-3xl font-bold text-center">教室座位神管理系統</h1>
            <p class="text-center mt-1 text-blue-100 text-sm">靈活神安排*視覺神管理</p>
        </div>
    </header>

    <main class="container mx-auto px-2 md:px-4 py-4 print-container flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div id="controls-column" class="lg:col-span-1 space-y-6 no-print">
            <div class="bg-white rounded-lg shadow-md controls-section">
                <h2 class="text-lg font-bold text-gray-800">基本設定</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-1 font-medium text-sm" for="classNameInput">班級名稱</label>
                    <input type="text" id="classNameInput" class="w-full px-3 py-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="例如：神來一班">
                </div>
                <div class="mb-4 border-t pt-4">
                    <label class="block text-gray-700 mb-1 font-medium text-sm">座位模式</label>
                    <div class="flex gap-4 text-sm">
                        <label class="inline-flex items-center"><input type="radio" class="form-radio text-blue-600 h-4 w-4" name="seatingMode" value="traditional" checked><span class="ml-1">傳統座位</span></label>
                        <label class="inline-flex items-center"><input type="radio" class="form-radio text-green-600 h-4 w-4" name="seatingMode" value="group"><span class="ml-1">小組座位</span></label>
                    </div>
                </div>
                <div id="traditionalInputs" class="grid grid-cols-2 gap-4 mb-4">
                    <div><label class="block text-gray-700 mb-1 font-medium text-sm" for="rows">座位列數</label><input type="number" id="rows" min="1" max="20" value="4" class="w-full px-3 py-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"></div>
                    <div><label class="block text-gray-700 mb-1 font-medium text-sm" for="cols">每列座位數</label><input type="number" id="cols" min="1" max="20" value="6" class="w-full px-3 py-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"></div>
                </div>
                <div id="groupInputs" class="grid grid-cols-2 gap-4 mb-4 hidden">
                     <div><label class="block text-gray-700 mb-1 font-medium text-sm" for="numGroups">初始分組數</label><input type="number" id="numGroups" min="0" max="25" value="5" class="w-full px-3 py-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm"></div>
                     <div><label class="block text-gray-700 mb-1 font-medium text-sm" for="studentsPerGroup">初始/新增座位</label><input type="number" id="studentsPerGroup" min="1" max="12" value="4" class="w-full px-3 py-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm"><p class="text-xs text-gray-500 mt-1">新小組預設座位數</p></div>
                     <div class="col-span-2 mt-2">
                        <button id="addGroupBtn" title="在座位表中新增一個小組" class="bg-green-600 hover:bg-green-700 text-white font-medium py-1.5 px-4 rounded-md transition duration-300 flex items-center text-sm w-full justify-center"><i class="fas fa-plus-circle mr-1"></i> 新增小組</button>
                     </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md controls-section">
                 <h2 class="text-lg font-bold text-gray-800">學生名單與匯入</h2>
                 <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium text-sm" for="students">學生名單 (座號 姓名 性別 (選填)需求)</label>
                        <textarea id="students" rows="5" class="w-full px-3 py-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="1 公小民 男 需要提醒
2 邱小瑜 女 沉癮AI無法自拔
..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">每行一位。座號、姓名、性別必填，需求選填。</p>
                        <div class="flex flex-wrap gap-3 items-center mt-3">
                            <button id="refreshStudentListBtn" title="重新讀取上方名單，更新現有座位上的學生資訊，並將新增學生放入空位 (不改變現有學生位置)" class="bg-teal-600 hover:bg-teal-700 text-white font-medium py-1.5 px-4 rounded-md transition duration-300 flex items-center text-sm"><i class="fas fa-sync-alt mr-1"></i> 重新整理</button>
                            <button id="sequentialArrangeBtn" title="依照學生名單順序排列座位 (將重設分組與位置)" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-1.5 px-4 rounded-md transition duration-300 flex items-center text-sm"><i class="fas fa-sort-amount-down mr-1"></i> 順序排列</button>
                            <button id="randomizeBtn" title="將學生名單隨機打亂後排列座位 (將重設分組與位置)" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-1.5 px-4 rounded-md transition duration-300 flex items-center text-sm"><i class="fas fa-random mr-1"></i> 隨機排列</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium text-sm">Excel 學生名單</label>
                        <div class="flex flex-col gap-2">
                            <div class="flex items-center gap-2"><input type="file" id="excelFile" accept=".xlsx, .xls" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-md file:border-0 file:text-xs file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><button id="importExcelBtn" title="從Excel匯入學生名單 (會覆蓋上方文字區內容並重設分組與座位)" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-1 px-2 rounded-md transition duration-300 flex items-center text-xs shrink-0"><i class="fas fa-file-import mr-1"></i> 匯入</button></div>
                            <a href="#" id="downloadTemplateBtn" class="text-blue-600 hover:text-blue-800 text-xs flex items-center"><i class="fas fa-download mr-1"></i> 下載範例 Excel 檔案</a>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">欄位需包含: 座號, 姓名, 性別, (選填)需求</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md controls-section">
                <h2 class="text-lg font-bold text-gray-800">顯示與操作設定</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                    <button id="perspectiveToggleBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-medium py-1.5 px-3 rounded-md transition duration-300 flex items-center justify-center text-xs"><i class="fas fa-sync-alt mr-1"></i> 切換視角</button>
                    <button id="toggleBlackboardBtn" class="bg-stone-500 hover:bg-stone-600 text-white font-medium py-1.5 px-3 rounded-md transition duration-300 flex items-center justify-center text-xs"><i class="fas fa-chalkboard mr-1"></i> 顯示黑板</button>
                    <button id="toggleTeacherDeskBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-1.5 px-3 rounded-md transition duration-300 flex items-center justify-center text-xs"><i class="fas fa-person-chalkboard mr-1"></i> 顯示講桌</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 border-b pb-4">
                    <div class="pr-4">
                        <label class="block text-gray-700 mb-1 font-medium text-sm">拖曳模式 (拖曳學生/空位時)</label>
                        <div class="flex flex-col gap-1 text-sm">
                            <label class="inline-flex items-center font-normal"><input type="radio" class="form-radio text-indigo-600 h-4 w-4" name="dragMode" value="insert" checked><span class="ml-1">插入/移動</span></label>
                            <label class="inline-flex items-center font-normal"><input type="radio" class="form-radio text-red-600 h-4 w-4" name="dragMode" value="swap"><span class="ml-1">交換位置</span></label>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">插入: 將學生/空位插入目標。交換: 與目標位置學生互換 (若目標為空則同插入)。</p>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium text-sm">網頁顯示選項</label>
                        <div class="flex items-center mt-1 text-sm"><input type="checkbox" id="showGenderCheckbox" class="h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300 rounded mr-1" checked><label for="showGenderCheckbox" class="text-gray-700">顯示性別區別</label></div>

                        <label class="block text-gray-700 mt-2 mb-1 font-medium text-sm">列印選項</label>
                        <div class="flex items-center mt-1 text-sm"><input type="checkbox" id="printNeedsCheckbox" class="h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-300 rounded mr-1" checked><label for="printNeedsCheckbox" class="text-gray-700">列印需求註記</label></div>
                        <div class="flex items-center mt-1 text-sm"><input type="checkbox" id="printGenderCheckbox" class="h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300 rounded mr-1" checked><label for="printGenderCheckbox" class="text-gray-700">列印性別區別</label></div>
                         <div class="flex items-center mt-1 text-sm"><input type="checkbox" id="printEmptySeatsCheckbox" class="h-4 w-4 text-slate-600 focus:ring-slate-500 border-gray-300 rounded mr-1" checked><label for="printEmptySeatsCheckbox" class="text-gray-700">列印空位標示</label></div>
                         <div class="flex items-center mt-1 text-sm"><input type="checkbox" id="printGroupNamesCheckbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-1" checked><label for="printGroupNamesCheckbox" class="text-gray-700">列印小組名稱</label></div>
                    </div>
                </div>
                <p class="text-xs text-gray-600" id="groupDragInfo">小組模式：可拖曳學生/空位換位，可拖曳整組（點擊小組名稱區域或空白處），可點 <span class="inline-block bg-gray-200 border border-gray-400 rounded-sm w-2 h-2 mx-0.5"></span> 上的 <i class="fas fa-times delete-seat-btn text-[9px] relative" style="display:inline-block; position:relative; opacity:1; background: #f87171; color:white; border-radius:50%; width:10px; height:10px; line-height:10px; top: -5px; right: -2px;"></i> 刪空位，點 <i class="fas fa-trash-alt delete-group-btn text-[9px] relative" style="display:inline-flex; position:relative; opacity:1; background: #ef4444; color:white; border-radius:3px; width:10px; height:10px; align-items:center; justify-content:center;"></i> 刪小組。(刪除操作將直接執行)</p>
                 <p class="text-xs text-gray-500 mt-1">提示：切換視角在小組模式下會改變講台/黑板位置，並反轉小組和座位顯示順序。</p>
            </div>
        </div>

        <div id="preview-column" class="lg:col-span-2">
             <div id="classroomLayout" class="bg-gray-100 rounded-lg shadow-inner p-2 md:p-4 classroom-layout relative overflow-x-auto h-full flex flex-col">
                 <h3 id="printClassName" class="text-center text-xl font-bold mb-4 hidden"></h3>
                 <h2 id="webClassName" class="text-center text-xl font-bold mb-2 text-gray-700"></h2>
                 <div class="flex justify-between items-center mb-3 flex-wrap gap-y-1 relative">
                     <h2 class="text-base md:text-lg text-center font-bold text-gray-800 w-full">座位表</h2>
                     <div class="flex gap-1.5 no-print absolute top-0 right-0">
                         <button id="exportLayoutBtn" title="匯出當前座位表佈局為 Excel" class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-1 px-2 rounded-md transition duration-300 flex items-center text-xs"><i class="fas fa-file-excel mr-1"></i> 匯出</button>
                         <button id="printBtn" title="列印座位表" class="bg-green-600 hover:bg-green-700 text-white font-medium py-1 px-2 rounded-md transition duration-300 flex items-center text-xs"><i class="fas fa-print mr-1"></i> 列印</button>
                     </div>
                 </div>
                 <div id="classInfo" class="text-gray-600 text-xs font-medium mb-2 text-center"></div>
                 <div id="classroomObjectsContainerTop" class="mb-2 h-[45px] flex items-center justify-center shrink-0"><div id="blackboardObject" class="classroom-object blackboard hidden w-4/5 max-w-md"><i class="fas fa-chalkboard mr-2"></i> 黑板</div></div>
                 <div id="teacherDeskContainerTop" class="mb-2 h-[35px] flex items-center justify-center shrink-0"><div id="teacherDeskObject" class="classroom-object teacher-desk-object hidden"><i class="fas fa-person-chalkboard mr-2"></i> 講桌</div></div>
                 <div id="seatingChartWrapper" class="flex-grow overflow-auto">
                     <div id="seatingChart" class="min-h-[250px] rounded bg-white shadow-sm pb-4"></div>
                 </div>
                 <div id="teacherDeskContainerBottom" class="mt-2 h-[35px] flex items-center justify-center shrink-0"></div>
                 <div id="classroomObjectsContainerBottom" class="mt-2 h-[45px] flex items-center justify-center shrink-0"></div>
                 <div class="mt-4 flex flex-wrap gap-x-3 gap-y-1 justify-center no-print border-t pt-2 text-xs shrink-0">
                     <span class="font-semibold mr-1">圖例:</span>
                     <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 border-l-[3px] border-blue-500"></div><span class="text-gray-600">男</span></div>
                     <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 border-l-[3px] border-pink-500"></div><span class="text-gray-600">女</span></div>
                     <span class="text-gray-500 text-[10px]">(需啟用顯示)</span>
                     <div class="flex items-center gap-1"><i class="fas fa-comment-dots needs-icon text-[9px] relative top-0 right-0"></i><span class="text-gray-600">需求(滑鼠懸停)</span></div>
                     <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 bg-gray-200 border border-gray-400 rounded-sm"></div><span class="text-gray-600">空位</span></div>
                     <div class="flex items-center gap-1"><i class="fas fa-times delete-seat-btn text-[9px]" style="display:inline-block; position:relative; opacity:1; background: #f87171; color:white; border-radius:50%; width:12px; height:12px; line-height:12px; top:-5px; right:-2px; z-index:1;"></i><span class="text-gray-600">刪空位(組)</span></div>
                     <div class="flex items-center gap-1"><i class="fas fa-trash-alt delete-group-btn text-[9px]" style="display:inline-flex; position:relative; opacity:1; background: #ef4444; color:white; border-radius:3px; width:12px; height:12px; align-items:center; justify-content:center;"></i><span class="text-gray-600">刪小組</span></div>
                     <div class="flex items-center gap-1"><i class="fas fa-pen-to-square text-blue-500 text-[9px]"></i><span class="text-gray-600">編輯組名</span></div>
                 </div>
             </div>
        </div>
    </main>
    <footer class="bg-gray-800 text-white py-3 no-print mt-auto">
        <div class="container mx-auto px-4 text-center text-xs">
            <p>Copyright © Liyuchiutiger Gongminshen</p>
        </div>
    </footer>

    <!-- NEW: Mascot Element -->
    <img id="mascot" src="image/LiyuChillGuy.svg" alt="LiyuChillGuy Mascot" class="no-print">

    <script>
        // ... (The entire ClassroomSeatingManager class and initialization logic remains here, unchanged from the version you provided)
        class ClassroomSeatingManager {
            constructor() {
                this.state = {
                    students: [],
                    layoutMap: new Map(),
                    groupNames: {},
                    seatingMode: 'traditional',
                    viewPerspective: 'teacher',
                    showBlackboard: false,
                    showTeacherDesk: false,
                    dragMode: 'insert',
                    showGender: true,
                    printNeeds: true,
                    printGender: true,
                    printEmptySeats: true,
                    printGroupNames: true,
                    className: '',
                    rows: 4,
                    cols: 6,
                    numGroups: 5,
                    studentsPerGroup: 4
                };
                this.sortableInstances = [];
                this.nextGroupId = 0;
                this.elements = this.getDOMElements();
                this.xlsx = XLSX;
                this.tempPrintClasses = { emptyGroups: new Set() };
                this.bindEventListeners();
                this.initialize();
            }

            getDOMElements() {
                return {
                    sequentialArrangeBtn: document.getElementById('sequentialArrangeBtn'),
                    randomizeBtn: document.getElementById('randomizeBtn'),
                    refreshStudentListBtn: document.getElementById('refreshStudentListBtn'),
                    printBtn: document.getElementById('printBtn'),
                    downloadTemplateBtn: document.getElementById('downloadTemplateBtn'),
                    importExcelBtn: document.getElementById('importExcelBtn'),
                    exportLayoutBtn: document.getElementById('exportLayoutBtn'),
                    perspectiveToggleBtn: document.getElementById('perspectiveToggleBtn'),
                    toggleBlackboardBtn: document.getElementById('toggleBlackboardBtn'),
                    toggleTeacherDeskBtn: document.getElementById('toggleTeacherDeskBtn'),
                    addGroupBtn: document.getElementById('addGroupBtn'),
                    excelFile: document.getElementById('excelFile'),
                    classNameInput: document.getElementById('classNameInput'),
                    rowsInput: document.getElementById('rows'),
                    colsInput: document.getElementById('cols'),
                    numGroupsInput: document.getElementById('numGroups'),
                    studentsPerGroupInput: document.getElementById('studentsPerGroup'),
                    studentsTextarea: document.getElementById('students'),
                    showGenderCheckbox: document.getElementById('showGenderCheckbox'),
                    printNeedsCheckbox: document.getElementById('printNeedsCheckbox'),
                    printGenderCheckbox: document.getElementById('printGenderCheckbox'),
                    printEmptySeatsCheckbox: document.getElementById('printEmptySeatsCheckbox'),
                    printGroupNamesCheckbox: document.getElementById('printGroupNamesCheckbox'),
                    printClassName: document.getElementById('printClassName'),
                    webClassName: document.getElementById('webClassName'),
                    traditionalInputsDiv: document.getElementById('traditionalInputs'),
                    groupInputsDiv: document.getElementById('groupInputs'),
                    classroomLayout: document.getElementById('classroomLayout'),
                    seatingChart: document.getElementById('seatingChart'),
                    classInfo: document.getElementById('classInfo'),
                    blackboardObject: document.getElementById('blackboardObject'),
                    teacherDeskObject: document.getElementById('teacherDeskObject'),
                    teacherDeskContainerTop: document.getElementById('teacherDeskContainerTop'),
                    teacherDeskContainerBottom: document.getElementById('teacherDeskContainerBottom'),
                    classroomObjectsContainerTop: document.getElementById('classroomObjectsContainerTop'),
                    classroomObjectsContainerBottom: document.getElementById('classroomObjectsContainerBottom'),
                    groupDragInfo: document.getElementById('groupDragInfo'),
                    seatingChartWrapper: document.getElementById('seatingChartWrapper'),
                    body: document.body,
                };
            }

            bindEventListeners() {
                this.elements.sequentialArrangeBtn.addEventListener('click', () => this.arrangeSeats(false));
                this.elements.randomizeBtn.addEventListener('click', () => this.arrangeSeats(true));
                this.elements.refreshStudentListBtn.addEventListener('click', () => this.refreshStudentDataAndUpdateDesks());
                this.elements.downloadTemplateBtn.addEventListener('click', (e) => this.generateExcelTemplate(e));
                this.elements.importExcelBtn.addEventListener('click', () => this.importStudentsFromExcel());
                this.elements.exportLayoutBtn.addEventListener('click', () => this.exportSeatingLayout());
                this.elements.printBtn.addEventListener('click', () => this.handlePrint());
                this.elements.perspectiveToggleBtn.addEventListener('click', () => this.togglePerspective());
                this.elements.toggleBlackboardBtn.addEventListener('click', () => this.toggleClassroomBlackboard());
                this.elements.toggleTeacherDeskBtn.addEventListener('click', () => this.toggleClassroomTeacherDesk());
                this.elements.showGenderCheckbox.addEventListener('change', () => this.toggleGenderDisplay());
                this.elements.printNeedsCheckbox.addEventListener('change', () => this.togglePrintNeeds());
                this.elements.printGenderCheckbox.addEventListener('change', () => this.togglePrintGender());
                this.elements.printEmptySeatsCheckbox.addEventListener('change', () => this.togglePrintEmptySeats());
                this.elements.printGroupNamesCheckbox.addEventListener('change', () => this.togglePrintGroupNames());
                this.elements.classNameInput.addEventListener('input', () => this.updateClassName());
                this.elements.addGroupBtn.addEventListener('click', () => this.addNewGroup());

                document.querySelectorAll('input[name="seatingMode"]').forEach(radio => {
                    radio.addEventListener('change', (e) => this.handleModeChange(e.target.value));
                });
                document.querySelectorAll('input[name="dragMode"]').forEach(radio => {
                    radio.addEventListener('change', (e) => this.state.dragMode = e.target.value);
                });
                [this.elements.rowsInput, this.elements.colsInput, this.elements.numGroupsInput, this.elements.studentsPerGroupInput].forEach(input => {
                    input.addEventListener('change', () => this.updateConfigFromInputsAndRender());
                });

                 this.elements.seatingChartWrapper.addEventListener('click', (e) => {
                    const deleteSeatBtn = e.target.closest('.delete-seat-btn');
                    const deleteGroupBtn = e.target.closest('.delete-group-btn');
                    const groupNameDisplay = e.target.closest('.group-name-display');

                    if (deleteSeatBtn) this.handleDeleteSeat(deleteSeatBtn);
                    else if (deleteGroupBtn) this.handleDeleteGroup(deleteGroupBtn);
                    else if (groupNameDisplay) this.handleGroupNameEditStart(groupNameDisplay);
                });
            }

            initialize() {
                this.elements.studentsTextarea.value = '';
                this.updateConditionalInputs();
                this.updateUIState();
                this.updatePrintOptionCheckboxes();
                this.setupPrintListener();
                this.arrangeSeats();
            }

            handleModeChange(newMode) {
                if (this.state.seatingMode !== newMode) {
                    this.state.seatingMode = newMode;
                    this.updateConditionalInputs();
                    this.arrangeSeats();
                }
            }

            updateConfigFromInputsAndRender() {
                this.state.rows = Math.max(1, parseInt(this.elements.rowsInput.value) || 1);
                this.state.cols = Math.max(1, parseInt(this.elements.colsInput.value) || 1);
                this.state.numGroups = Math.max(0, parseInt(this.elements.numGroupsInput.value) || 0);
                this.state.studentsPerGroup = Math.max(1, parseInt(this.elements.studentsPerGroupInput.value) || 1);
                this.elements.rowsInput.value = this.state.rows;
                this.elements.colsInput.value = this.state.cols;
                this.elements.numGroupsInput.value = this.state.numGroups;
                this.elements.studentsPerGroupInput.value = this.state.studentsPerGroup;
                this.arrangeSeats();
            }

            updateClassName() {
                this.state.className = this.elements.classNameInput.value.trim();
                this.elements.webClassName.textContent = this.state.className;
                this.elements.printClassName.textContent = this.state.className || '座位表';
            }

            updateConditionalInputs() {
                const isTraditional = this.state.seatingMode === 'traditional';
                this.elements.traditionalInputsDiv.classList.toggle('hidden', !isTraditional);
                this.elements.groupInputsDiv.classList.toggle('hidden', isTraditional);
                this.elements.groupDragInfo.classList.toggle('hidden', isTraditional);
                this.elements.addGroupBtn.classList.toggle('hidden', isTraditional);
                const currentModeRadio = document.querySelector(`input[name="seatingMode"][value="${this.state.seatingMode}"]`);
                if (currentModeRadio) currentModeRadio.checked = true;
            }

            parseStudents(text) {
                const generateUniqueId = () => `s_${Date.now()}_${Math.random().toString(16).slice(2)}`;
                const students = [];
                const seenNumbers = new Set(); 
                text.split('\n').map(l => l.trim()).filter(l => l).forEach((line) => {
                    const parts = line.split(/\s+/);
                    if (parts.length < 3) return;
                    const number = parts[0].trim();
                    const name = parts[1].trim();
                    const genderInput = parts[2].toLowerCase();
                    const needs = parts.length >= 4 ? parts.slice(3).join(' ').trim() : null;
                    let gender = '未知';
                    if (['男', 'm', 'male'].includes(genderInput)) gender = '男';
                    else if (['女', 'f', 'female'].includes(genderInput)) gender = '女';
                    if (number && seenNumbers.has(number)) {
                       console.warn(`Duplicate student number "${number}" detected in list. Using first occurrence.`);
                       return;
                    }
                    if(number) seenNumbers.add(number);
                    students.push({ id: generateUniqueId(), number: number || null, name: name, gender: gender, needs: needs });
                });
                return students;
            }

            arrangeSeats(randomize = false) {
                this.state.students = this.parseStudents(this.elements.studentsTextarea.value);
                this.state.groupNames = {};
                this.nextGroupId = 0;
                this.state.layoutMap.clear();
                let initialCapacity = this.state.seatingMode === 'traditional' ? this.state.rows * this.state.cols : this.state.numGroups * this.state.studentsPerGroup;
                let studentsToPlace = [...this.state.students];
                if (studentsToPlace.length > initialCapacity && initialCapacity > 0) console.warn(`Student count (${studentsToPlace.length}) > initial capacity (${initialCapacity}).`);
                else if (initialCapacity <= 0 && studentsToPlace.length > 0) { console.warn(`Initial capacity <= 0 (${initialCapacity}). Cannot place students.`); studentsToPlace = []; }
                if (randomize) studentsToPlace = this.shuffleArray(studentsToPlace);
                let studentIndex = 0;
                if (this.state.seatingMode === 'traditional') {
                     for (let i = 0; i < this.state.rows; i++) {
                        for (let j = 0; j < this.state.cols; j++) {
                            const deskId = `r${i}c${j}`;
                            if (studentIndex < studentsToPlace.length) { this.state.layoutMap.set(deskId, studentsToPlace[studentIndex++]); }
                        }
                     }
                } else {
                     for (let g = 0; g < this.state.numGroups; g++) {
                         const currentGroupIndex = this.nextGroupId++;
                         const groupKey = `g${currentGroupIndex}`;
                         this.state.groupNames[groupKey] = `第 ${currentGroupIndex + 1} 組`;
                         for (let s = 0; s < this.state.studentsPerGroup; s++) {
                            const deskId = `${groupKey}d${s}`;
                            if (studentIndex < studentsToPlace.length) { this.state.layoutMap.set(deskId, studentsToPlace[studentIndex++]); }
                        }
                     }
                     this.nextGroupId = this.state.numGroups;
                }
                this.renderSeatingChart();
            }

            refreshStudentDataAndUpdateDesks() {
                const newStudentsData = this.parseStudents(this.elements.studentsTextarea.value);
                const newStudentMapByNumber = new Map(newStudentsData.map(s => [s.number, s]));
                const currentDeskElements = Array.from(this.elements.seatingChart.querySelectorAll('.desk'));
                const availableEmptyDeskIds = [];
                const assignedDeskIds = new Set();
                currentDeskElements.forEach(deskElement => {
                    const deskId = deskElement.dataset.deskId;
                    const currentStudentNumber = deskElement.dataset.studentNumber;
                    if (currentStudentNumber) {
                        const updatedStudentData = newStudentMapByNumber.get(currentStudentNumber);
                        if (updatedStudentData) {
                            this._updateDeskContent(deskElement, updatedStudentData);
                            this.state.layoutMap.set(deskId, updatedStudentData);
                            newStudentMapByNumber.delete(currentStudentNumber);
                            assignedDeskIds.add(deskId);
                        } else {
                            this._updateDeskContent(deskElement, null);
                            this.state.layoutMap.delete(deskId);
                            availableEmptyDeskIds.push(deskId);
                            assignedDeskIds.add(deskId);
                        }
                    } else {
                         if (deskId && !this.state.layoutMap.has(deskId)) { availableEmptyDeskIds.push(deskId); }
                         else if (deskId && this.state.layoutMap.has(deskId)) { this.state.layoutMap.delete(deskId); availableEmptyDeskIds.push(deskId); }
                    }
                });
                const studentsToAdd = Array.from(newStudentMapByNumber.values());
                studentsToAdd.forEach(newStudent => {
                    if (availableEmptyDeskIds.length > 0) {
                        const targetDeskId = availableEmptyDeskIds.shift();
                        const targetDeskElement = this.elements.seatingChart.querySelector(`.desk[data-desk-id="${targetDeskId}"]`);
                        if (targetDeskElement) {
                            this._updateDeskContent(targetDeskElement, newStudent);
                            this.state.layoutMap.set(targetDeskId, newStudent);
                            assignedDeskIds.add(targetDeskId);
                        }
                    }
                });
                this.state.students = newStudentsData;
                this.updateClassInfo(currentDeskElements.length, this.state.layoutMap.size);
                this.updateGenderVisibility();
            }

            renderSeatingChart() {
                this.destroySortable();
                const seatingChart = this.elements.seatingChart;
                seatingChart.innerHTML = '';
                seatingChart.className = `min-h-[250px] rounded bg-white shadow-sm pb-4 mode-${this.state.seatingMode}`;
                let totalSlots = 0;
                if (this.state.seatingMode === 'traditional') {
                    totalSlots = this.renderTraditionalLayoutStructure();
                } else {
                    totalSlots = this.renderGroupLayoutStructure();
                }
                this.populateDesksFromMap();
                this.updateClassInfo(totalSlots, this.state.layoutMap.size);
                this.renderClassroomObjects();
                this.updateClassName();
                if (this.state.seatingMode === 'traditional') {
                    this.initSortableForTraditional();
                } else {
                    this.initSortableForGroups();
                    this.initSortableForGroupContainers();
                }
                this.updateGenderVisibility();
            }

            renderTraditionalLayoutStructure() {
                const chart = this.elements.seatingChart;
                chart.style.display = 'grid';
                chart.style.gridTemplateColumns = `repeat(${this.state.cols}, minmax(var(--desk-width), auto))`;
                chart.style.gap = '6px'; chart.style.padding = '5px';
                const rowIndices = this.state.viewPerspective === 'teacher' ? Array.from({ length: this.state.rows }, (_, i) => i) : Array.from({ length: this.state.rows }, (_, i) => this.state.rows - 1 - i);
                const colIndices = this.state.viewPerspective === 'teacher' ? Array.from({ length: this.state.cols }, (_, j) => j) : Array.from({ length: this.state.cols }, (_, j) => this.state.cols - 1 - j);
                let deskCount = 0;
                for (const i of rowIndices) {
                    for (const j of colIndices) {
                        const seatId = `r${i}c${j}`;
                        chart.appendChild(this.createDeskElement(seatId, null));
                        deskCount++;
                    }
                }
                return deskCount;
            }

            renderGroupLayoutStructure() {
                const chart = this.elements.seatingChart;
                chart.style.display = 'flex'; chart.style.flexWrap = 'wrap'; chart.style.justifyContent = 'center'; chart.style.alignItems = 'flex-start'; chart.style.gap = '12px'; chart.style.padding = '10px'; chart.style.gridTemplateColumns = '';
                let groupIndicesToRender = this.getGroupIndicesToRender();
                const groupContainerElements = [];
                let totalRenderedDesks = 0;
                groupIndicesToRender.forEach(gIndex => {
                    const groupKey = `g${gIndex}`;
                    const groupContainer = this.createGroupContainerElement(groupKey);
                    const existingDeskIds = Array.from(this.state.layoutMap.keys()).filter(id => id.startsWith(`${groupKey}d`));
                    let maxExistingDeskIndex = -1;
                    existingDeskIds.forEach(deskId => { const match = deskId.match(/d(\d+)$/); if (match && match[1]) maxExistingDeskIndex = Math.max(maxExistingDeskIndex, parseInt(match[1])); });
                    const targetSlots = Math.max(1, this.state.studentsPerGroup, maxExistingDeskIndex + 1);
                    const deskElements = [];
                    for (let s_logical = 0; s_logical < targetSlots; s_logical++) {
                       const deskId = `${groupKey}d${s_logical}`;
                       deskElements.push(this.createDeskElement(deskId, null));
                       totalRenderedDesks++;
                    }
                    if (this.state.viewPerspective === 'student') { deskElements.reverse(); }
                    deskElements.forEach(deskEl => groupContainer.appendChild(deskEl));
                    groupContainerElements.push(groupContainer);
                });
                const finalGroupOrder = this.state.viewPerspective === 'student' ? groupContainerElements.reverse() : groupContainerElements;
                finalGroupOrder.forEach(groupEl => chart.appendChild(groupEl));
                return totalRenderedDesks;
            }

            populateDesksFromMap() {
                this.state.layoutMap.forEach((student, deskId) => {
                    const deskElement = this.elements.seatingChart.querySelector(`.desk[data-desk-id="${deskId}"]`);
                    if (deskElement) { this._updateDeskContent(deskElement, student); }
                });
            }

            getGroupIndicesToRender() {
                 const groupIndicesInMap = new Set();
                 this.state.layoutMap.forEach((_, key) => { if (key.startsWith('g')) { const match = key.match(/^g(\d+)/); if (match && match[1]) groupIndicesInMap.add(parseInt(match[1])); } });
                 Object.keys(this.state.groupNames).forEach(groupKey => { const match = groupKey.match(/^g(\d+)$/); if (match && match[1]) groupIndicesInMap.add(parseInt(match[1])); });
                 const maxConfigGroupIndex = this.state.seatingMode === 'group' ? Math.max(0, this.state.numGroups - 1, this.nextGroupId - 1) : -1;
                 if (maxConfigGroupIndex >= 0) { for(let i = 0; i <= maxConfigGroupIndex; i++) { if(this.state.groupNames[`g${i}`] !== undefined || i < this.state.numGroups) { groupIndicesInMap.add(i); } } }
                 const highestIndex = groupIndicesInMap.size > 0 ? Math.max(...Array.from(groupIndicesInMap)) : -1;
                 this.nextGroupId = Math.max(this.nextGroupId, highestIndex + 1);
                 return Array.from(groupIndicesInMap).sort((a, b) => a - b);
            }

            createGroupContainerElement(groupKey) {
                 const groupIndex = parseInt(groupKey.substring(1));
                 const groupContainer = document.createElement('div');
                 groupContainer.className = 'group-container';
                 groupContainer.dataset.groupKey = groupKey;
                 groupContainer.style.borderColor = this.getGroupColor(groupIndex);
                 const nameContainer = document.createElement('div'); nameContainer.className = 'group-name-container';
                 const nameDisplay = document.createElement('span'); nameDisplay.className = 'group-name-display';
                 if (this.state.groupNames[groupKey] === undefined) { this.state.groupNames[groupKey] = `第 ${groupIndex + 1} 組`; }
                 const currentName = this.state.groupNames[groupKey]; nameDisplay.textContent = currentName; nameDisplay.title = `點擊編輯${currentName ? ` "${currentName}"` : '小組名稱'}`;
                 const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.className = 'group-name-input'; nameInput.value = currentName; nameInput.maxLength = 30; nameInput.spellcheck = false;
                 nameInput.addEventListener('blur', (e) => this.handleGroupNameEditEnd(e.target));
                 nameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') e.target.blur(); else if (e.key === 'Escape') { const groupKeyFromInput = e.target.closest('.group-container')?.dataset.groupKey; if(groupKeyFromInput) { const originalName = this.state.groupNames[groupKeyFromInput] ?? `第 ${parseInt(groupKeyFromInput.substring(1)) + 1} 組`; e.target.value = originalName; } e.target.blur(); } });
                 nameContainer.appendChild(nameDisplay); nameContainer.appendChild(nameInput);
                 groupContainer.appendChild(nameContainer);
                 groupContainer.appendChild(this.createDeleteGroupButton());
                 return groupContainer;
            }

            handleGroupNameEditStart(nameDisplayElement) { const nameInput = nameDisplayElement.nextElementSibling; if (!nameInput) return; nameDisplayElement.classList.add('editing'); nameInput.classList.add('editing'); nameInput.select(); nameInput.focus(); }
            handleGroupNameEditEnd(nameInputElement) { const nameDisplay = nameInputElement.previousElementSibling; const groupContainer = nameInputElement.closest('.group-container'); if (!nameDisplay || !groupContainer) return; const groupKey = groupContainer.dataset.groupKey; const newName = nameInputElement.value.trim(); this.state.groupNames[groupKey] = newName; nameDisplay.textContent = newName; nameDisplay.title = `點擊編輯${newName ? ` "${newName}"` : '小組名稱'}`; nameInputElement.classList.remove('editing'); nameDisplay.classList.remove('editing'); }
            getGroupColor(index) { const colors = ['#fca5a5','#fdba74','#fde047','#86efac','#93c5fd','#d8b4fe','#f9a8d4','#a7f3d0','#fbcfe8','#bfdbfe', '#a5f3fc', '#bbf7d0', '#fef08a', '#fed7aa', '#fecaca']; return colors[index % colors.length]; }
            createDeleteGroupButton() { const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-group-btn no-print'; deleteBtn.innerHTML = '<i class="fas fa-trash-alt fa-xs pointer-events-none"></i>'; deleteBtn.title = '刪除此小組 (直接刪除)'; return deleteBtn; }
            createDeleteSeatButton() { const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-seat-btn no-print'; deleteBtn.innerHTML = '×'; deleteBtn.title = '刪除此空位 (直接刪除)'; return deleteBtn; }

            _updateDeskContent(deskElement, student) {
                 deskElement.innerHTML = ''; deskElement.classList.remove('empty-seat', 'male', 'female'); delete deskElement.dataset.studentId; delete deskElement.dataset.studentNumber; deskElement.draggable = true; deskElement.style.cursor = 'grab';
                 if (student && student.name) {
                     deskElement.dataset.studentId = student.id; if(student.number) deskElement.dataset.studentNumber = student.number;
                     const genderClass = student.gender === '男' ? 'male' : student.gender === '女' ? 'female' : '';
                     const genderSymbol = student.gender === '男' ? '♂' : student.gender === '女' ? '♀' : '';
                     if (genderClass) deskElement.classList.add(genderClass);
                     const infoDiv = document.createElement('div'); infoDiv.className = 'student-info w-full text-center text-[11px] leading-tight';
                     const nameLine = document.createElement('div'); nameLine.className = 'student-name-line font-semibold text-gray-800 truncate';
                     const studentDisplayText = `${student.number || '?'} ${student.name}`;
                     nameLine.title = `${studentDisplayText}${student.needs ? ` (${student.needs})` : ''}`;
                     nameLine.innerHTML = `${studentDisplayText} <span class="gender-symbol">${genderSymbol}</span>`;
                     infoDiv.appendChild(nameLine);
                     const needsPrintDiv = document.createElement('div'); needsPrintDiv.className = 'desk-needs-print'; needsPrintDiv.textContent = student.needs || ''; infoDiv.appendChild(needsPrintDiv);
                     deskElement.appendChild(infoDiv);
                     if (student.needs) { const needsIconSpan = document.createElement('span'); needsIconSpan.className = 'needs-icon'; needsIconSpan.innerHTML = `<i class="fas ${this.getNeedsIcon(student.needs)}"></i><span class="tooltip">${student.needs}</span>`; deskElement.appendChild(needsIconSpan); }
                 } else {
                     deskElement.classList.add('empty-seat'); deskElement.style.cursor = 'grab';
                     const emptyText = document.createElement('div'); emptyText.className = 'text-gray-400 text-[10px]'; emptyText.textContent = '空位'; deskElement.appendChild(emptyText);
                     if (this.state.seatingMode === 'group') { deskElement.appendChild(this.createDeleteSeatButton()); }
                     delete deskElement.dataset.studentId; delete deskElement.dataset.studentNumber;
                 }
                 this.updateGenderVisibility();
            }

            createDeskElement(deskId, student) {
                const deskElement = document.createElement('div'); deskElement.className = 'desk'; deskElement.dataset.deskId = deskId;
                this._updateDeskContent(deskElement, student);
                return deskElement;
             }

            renderClassroomObjects() {
                const showBb = this.state.showBlackboard; const showTd = this.state.showTeacherDesk;
                this.elements.blackboardObject.classList.toggle('hidden', !showBb); this.elements.teacherDeskObject.classList.toggle('hidden', !showTd);
                this.elements.teacherDeskContainerTop.innerHTML = ''; this.elements.teacherDeskContainerBottom.innerHTML = ''; this.elements.classroomObjectsContainerTop.innerHTML = ''; this.elements.classroomObjectsContainerBottom.innerHTML = '';
                const [bbContainer, tdContainer] = (this.state.viewPerspective === 'teacher') ? [this.elements.classroomObjectsContainerTop, this.elements.teacherDeskContainerTop] : [this.elements.classroomObjectsContainerBottom, this.elements.teacherDeskContainerBottom];
                if (showBb) bbContainer.appendChild(this.elements.blackboardObject);
                if (showTd) tdContainer.appendChild(this.elements.teacherDeskObject);
            }

            updateUIState() {
                 this.elements.perspectiveToggleBtn.innerHTML = `<i class="fas fa-sync-alt mr-1"></i> ${this.state.viewPerspective === 'teacher' ? '切換學生視角' : '切換教師視角'}`;
                 ['Blackboard', 'TeacherDesk'].forEach(type => { const showState = this.state[`show${type}`]; const btn = this.elements[`toggle${type}Btn`]; const icon = type === 'Blackboard' ? 'fa-chalkboard' : 'fa-person-chalkboard'; const text = type === 'Blackboard' ? '黑板' : '講桌'; const color = type === 'Blackboard' ? 'stone' : 'purple'; btn.innerHTML = `<i class="fas ${icon} mr-1"></i> ${showState ? '隱藏' : '顯示'}${text}`; btn.classList.remove(`bg-${color}-700`, `hover:bg-${color}-800`, `bg-${color}-500`, `hover:bg-${color}-600`); btn.classList.add(`bg-${color}-${showState ? '700' : '500'}`, `hover:bg-${color}-${showState ? '800' : '600'}`); });
                 this.elements.showGenderCheckbox.checked = this.state.showGender; this.updateGenderVisibility();
             }
            updatePrintOptionCheckboxes() { this.elements.printNeedsCheckbox.checked = this.state.printNeeds; this.elements.printGenderCheckbox.checked = this.state.printGender; this.elements.printEmptySeatsCheckbox.checked = this.state.printEmptySeats; this.elements.printGroupNamesCheckbox.checked = this.state.printGroupNames; }

            togglePerspective() {
                this.state.viewPerspective = this.state.viewPerspective === 'teacher' ? 'student' : 'teacher';
                this.updateUIState();
                this.renderSeatingChart();
            }

            toggleClassroomBlackboard() { this.state.showBlackboard = !this.state.showBlackboard; this.updateUIState(); this.renderClassroomObjects(); }
            toggleClassroomTeacherDesk() { this.state.showTeacherDesk = !this.state.showTeacherDesk; this.updateUIState(); this.renderClassroomObjects(); }
            toggleGenderDisplay() { this.state.showGender = this.elements.showGenderCheckbox.checked; this.updateGenderVisibility(); }
            togglePrintNeeds() { this.state.printNeeds = this.elements.printNeedsCheckbox.checked; }
            togglePrintGender() { this.state.printGender = this.elements.printGenderCheckbox.checked; }
            togglePrintEmptySeats() { this.state.printEmptySeats = this.elements.printEmptySeatsCheckbox.checked; }
            togglePrintGroupNames() { this.state.printGroupNames = this.elements.printGroupNamesCheckbox.checked; }

            updateGenderVisibility() { this.elements.classroomLayout.classList.toggle('gender-visible', this.state.showGender); }

            destroySortable() {
                this.sortableInstances.forEach((instance) => { if (instance && typeof instance.destroy === 'function') { try { instance.destroy(); } catch (e) { console.error(`Error destroying sortable:`, instance.el, e); } } });
                this.sortableInstances = [];
                const containers = [this.elements.seatingChart, ...this.elements.seatingChart.querySelectorAll('.group-container')];
                containers.forEach(el => { if (el && Sortable.get(el)) { try { Sortable.get(el).destroy(); } catch(e) { console.error("Error destroying lingering sortable:", el, e); } } });
            }

            initSortableForTraditional() {
                 if (this.state.seatingMode !== 'traditional') return;
                 if(Sortable.get(this.elements.seatingChart)) { Sortable.get(this.elements.seatingChart).destroy();}
                 const instance = new Sortable(this.elements.seatingChart, { group: 'shared-desks', animation: 150, ghostClass: 'sortable-ghost', chosenClass: "sortable-chosen", dragClass: "sortable-drag", forceFallback: false, onEnd: (evt) => this.handleDragEnd(evt) });
                 this.sortableInstances.push(instance);
             }

            initSortableForGroups() {
                 if (this.state.seatingMode !== 'group') return;
                 this.elements.seatingChart.querySelectorAll('.group-container').forEach(container => {
                     if(Sortable.get(container)) { Sortable.get(container).destroy();}
                     const instance = new Sortable(container, { group: 'shared-desks', animation: 150, ghostClass: 'sortable-ghost', chosenClass: "sortable-chosen", dragClass: "sortable-drag", forceFallback: false, onEnd: (evt) => this.handleDragEnd(evt) });
                     this.sortableInstances.push(instance);
                 });
             }

            initSortableForGroupContainers() {
                 if (this.state.seatingMode !== 'group') return;
                 const existingGroupSortable = this.sortableInstances.find(inst => inst.el === this.elements.seatingChart && inst.options.group !== 'shared-desks');
                 if (existingGroupSortable) { return; }
                 const existingDeskSortable = Sortable.get(this.elements.seatingChart);
                 if (existingDeskSortable && existingDeskSortable.options.group === 'shared-desks') { existingDeskSortable.destroy(); }
                 const instance = new Sortable(this.elements.seatingChart, { animation: 150, filter: '.desk', preventOnFilter: true, ghostClass: 'sortable-ghost-group', chosenClass: "sortable-chosen", dragClass: "sortable-drag", forceFallback: false, onEnd: (evt) => { this.updateLayoutMapBasedOnDOM(); } });
                 this.sortableInstances.push(instance);
             }

            handleDragEnd(evt) {
                 const { item: draggedItem, to: targetList, from: sourceList, newIndex: newVisualIndex } = evt;
                 const draggedOriginalDeskId = draggedItem.dataset.deskId;
                 if (!draggedOriginalDeskId) { this.renderSeatingChart(); return; }
                 if (this.state.dragMode === 'swap') {
                     const targetElement = targetList.children[newVisualIndex];
                     if (targetElement && targetElement !== draggedItem && targetElement.classList.contains('desk')) {
                         const isDraggedItemEmpty = draggedItem.classList.contains('empty-seat');
                         const draggedStudent = isDraggedItemEmpty ? null : this.state.layoutMap.get(draggedOriginalDeskId);
                         const isTargetEmpty = targetElement.classList.contains('empty-seat');
                         const targetOriginalDeskId = targetElement.dataset.deskId;
                         const targetStudent = isTargetEmpty ? null : this.state.layoutMap.get(targetOriginalDeskId);
                         if (!targetOriginalDeskId) { this.renderSeatingChart(); return; }
                         if (targetStudent) this.state.layoutMap.set(draggedOriginalDeskId, targetStudent); else this.state.layoutMap.delete(draggedOriginalDeskId);
                         if (draggedStudent) this.state.layoutMap.set(targetOriginalDeskId, draggedStudent); else this.state.layoutMap.delete(targetOriginalDeskId);
                         this.renderSeatingChart();
                         return;
                     }
                 }
                 this.updateLayoutMapBasedOnDOM();
            }

            updateLayoutMapBasedOnDOM() {
                const newLayoutMap = new Map();
                let currentDeskCount = 0;
                const studentMapById = new Map(this.state.students.map(s => [s.id, s]));
                if (this.state.seatingMode === 'traditional') {
                    this.elements.seatingChart.querySelectorAll('.desk').forEach((deskElement) => {
                        currentDeskCount++;
                        const deskId = deskElement.dataset.deskId; if (!deskId) return;
                        const studentId = deskElement.dataset.studentId;
                        if (studentId && !deskElement.classList.contains('empty-seat')) { const student = studentMapById.get(studentId); if (student) newLayoutMap.set(deskId, student); }
                    });
                } else {
                    this.elements.seatingChart.querySelectorAll('.group-container').forEach((container) => {
                        const groupKey = container.dataset.groupKey; if (!groupKey) return;
                        const groupDesks = Array.from(container.querySelectorAll('.desk')); currentDeskCount += groupDesks.length;
                        groupDesks.forEach((deskElement, visualDeskIndex) => {
                             const newDeskId = `${groupKey}d${visualDeskIndex}`; deskElement.dataset.deskId = newDeskId;
                             const studentId = deskElement.dataset.studentId;
                             if (studentId && !deskElement.classList.contains('empty-seat')) { const student = studentMapById.get(studentId); if (student) newLayoutMap.set(newDeskId, student); }
                        });
                    });
                }
                this.state.layoutMap = newLayoutMap;
                this.updateClassInfo(currentDeskCount, this.state.layoutMap.size);
            }

            handleDeleteSeat(deleteButton) { if (this.state.seatingMode !== 'group') return; const deskElement = deleteButton.closest('.desk.empty-seat'); if (!deskElement) return; const groupContainer = deskElement.closest('.group-container'); if (!groupContainer) return; const deskId = deskElement.dataset.deskId; if(deskId) this.state.layoutMap.delete(deskId); deskElement.remove(); this.updateLayoutMapBasedOnDOM(); }
            handleDeleteGroup(deleteButton) { if (this.state.seatingMode !== 'group') return; const groupContainer = deleteButton.closest('.group-container'); if (!groupContainer) return; const groupKey = groupContainer.dataset.groupKey; const sortableInstance = this.sortableInstances.find(inst => inst.el === groupContainer); if (sortableInstance) { try { sortableInstance.destroy(); } catch (e) {} this.sortableInstances = this.sortableInstances.filter(inst => inst !== sortableInstance); } if(groupKey) delete this.state.groupNames[groupKey]; groupContainer.remove(); this.updateLayoutMapBasedOnDOM(); }
            
            addNewGroup() {
                 if (this.state.seatingMode !== 'group') return;
                 const newGroupIndex = this.nextGroupId++; const newGroupKey = `g${newGroupIndex}`;
                 this.state.groupNames[newGroupKey] = `第 ${newGroupIndex + 1} 組`;
                 const groupContainer = this.createGroupContainerElement(newGroupKey);
                 const initialSeats = Math.max(1, this.state.studentsPerGroup);
                 for (let s = 0; s < initialSeats; s++) { const deskId = `${newGroupKey}d${s}`; groupContainer.appendChild(this.createDeskElement(deskId, null)); }
                 const chart = this.elements.seatingChart;
                 if(this.state.viewPerspective === 'student'){ chart.insertBefore(groupContainer, chart.firstChild); } else { chart.appendChild(groupContainer); }
                 const deskSortable = new Sortable(groupContainer, { group: 'shared-desks', animation: 150, ghostClass: 'sortable-ghost', chosenClass: "sortable-chosen", dragClass: "sortable-drag", forceFallback: false, onEnd: (evt) => this.handleDragEnd(evt) });
                 this.sortableInstances.push(deskSortable);
                 this.updateLayoutMapBasedOnDOM();
            }

            handlePrint() {
                 this.elements.printClassName.textContent = this.state.className || '座位表'; this.elements.printClassName.classList.remove('hidden');
                 this.tempPrintClasses.emptyGroups.clear();
                 this.elements.body.classList.toggle('print-hide-needs', !this.state.printNeeds);
                 this.elements.body.classList.toggle('print-hide-gender', !this.state.printGender);
                 this.elements.body.classList.toggle('print-hide-empty', !this.state.printEmptySeats);
                 this.elements.body.classList.toggle('print-hide-group-names', !this.state.printGroupNames);
                 if (!this.state.printEmptySeats && this.state.seatingMode === 'group') {
                     this.elements.seatingChart.querySelectorAll('.group-container').forEach(container => {
                         const hasStudents = container.querySelector('.desk:not(.empty-seat)');
                         if (!hasStudents) { container.classList.add('print-empty-group'); this.tempPrintClasses.emptyGroups.add(container); }
                     });
                 }
                 window.print();
            }
            _cleanupAfterPrint() {
                 this.elements.body.classList.remove('print-hide-needs', 'print-hide-gender', 'print-hide-empty', 'print-hide-group-names');
                 this.tempPrintClasses.emptyGroups.forEach(container => { container.classList.remove('print-empty-group'); });
                 this.tempPrintClasses.emptyGroups.clear();
                 this.elements.printClassName.textContent = ''; this.elements.printClassName.classList.add('hidden');
            }
            setupPrintListener() { const afterPrintHandler = () => this._cleanupAfterPrint(); if (window.matchMedia) { const mediaQueryList = window.matchMedia('print'); const handleChange = (mql) => { if (!mql.matches) { afterPrintHandler(); } }; if (mediaQueryList.addEventListener) { mediaQueryList.addEventListener('change', handleChange); } else if (mediaQueryList.addListener) { mediaQueryList.addListener(handleChange); } } window.onafterprint = afterPrintHandler; }
            getNeedsIcon(needs) { if (!needs) return 'fa-comment-dots'; const l = needs.toLowerCase(); if (l.includes('視力')||l.includes('vision')) return 'fa-eye'; if (l.includes('聽力')||l.includes('hearing')) return 'fa-ear-listen'; if (l.includes('協助')||l.includes('support')) return 'fa-hands-helping'; if (l.includes('行動')||l.includes('mobility')) return 'fa-wheelchair'; if (l.includes('過動')||l.includes('adhd')) return 'fa-bolt'; if (l.includes('提醒')||l.includes('prompt')) return 'fa-bell'; if (l.includes('安靜')||l.includes('quiet')) return 'fa-volume-xmark'; if (l.includes('資優')||l.includes('gifted')) return 'fa-star'; if (l.includes('學習')||l.includes('learn')) return 'fa-book-open-reader'; if (l.includes('情緒')||l.includes('emotion')) return 'fa-face-sad-tear'; return 'fa-comment-dots'; }
            updateClassInfo(totalDeskCount, assignedCount) { const emptySeats = Math.max(0, totalDeskCount - assignedCount); this.elements.classInfo.innerHTML = `座位總數: <span class="font-medium">${totalDeskCount}</span> | 已排人數: <span class="text-blue-600 font-medium">${assignedCount}</span> | 空位數: <span class="text-green-600 font-medium">${emptySeats}</span>`; }
            
            generateExcelTemplate(e) { e.preventDefault(); const wb = this.xlsx.utils.book_new(); const wsData = [ ['座號', '姓名', '性別', '需求'], ['1', '公小民', '男', '需要提醒'], ['2', '邱小瑜', '女', '沉癮AI無法自拔'], ['3', '陳大德', 'Male', ''], ['4', '林美盛', 'F', '視力不好'], ['5', '王小俐', 'F', ''] ]; const ws = this.xlsx.utils.aoa_to_sheet(wsData); ws['!cols'] = [ { wch: 8 }, { wch: 12 }, { wch: 6 }, { wch: 25 } ]; this.xlsx.utils.book_append_sheet(wb, ws, '學生名單'); this.xlsx.writeFile(wb, '學生名單範本.xlsx'); }
            
            importStudentsFromExcel() {
                 const fileInput = this.elements.excelFile; if (!fileInput.files || fileInput.files.length === 0) { alert('請選擇 Excel 檔案！'); return; } const file = fileInput.files[0]; const reader = new FileReader();
                 reader.onload = (e) => { try {
                     const data = new Uint8Array(e.target.result); const workbook = this.xlsx.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName];
                     const jsonDataRaw = this.xlsx.utils.sheet_to_json(worksheet, { header: 1, defval: '', blankrows: false }); const jsonData = jsonDataRaw.filter(row => Array.isArray(row) && row.some(cell => cell !== null && String(cell).trim() !== '')); if (jsonData.length === 0) { alert('Excel 檔案似乎是空的。'); return; }
                     let headerRowIndex = -1; let headers = {}; const headerKeywords = { number: ['座號', '學號'], name: ['姓名'], gender: ['性別'], needs: ['需求', '註記', '備註'] };
                     for (let i = 0; i < Math.min(5, jsonData.length); i++) { const row = jsonData[i]; const potentialHeaders = row.map(cell => String(cell).trim().toLowerCase()); let tempHeaders = {}; potentialHeaders.forEach((headerText, colIndex) => { for (const key in headerKeywords) { if (headerKeywords[key].includes(headerText)) { tempHeaders[key] = colIndex; break; } } }); if (tempHeaders.name !== undefined && (tempHeaders.gender !== undefined || tempHeaders.number !== undefined)) { headers = tempHeaders; headerRowIndex = i; break; } }
                     let dataStartIndex = 0; if (headerRowIndex !== -1) { dataStartIndex = headerRowIndex + 1; if (headers.name === undefined || (headers.gender === undefined && headers.number === undefined) ) { alert("無法可靠識別 '姓名' 和 '性別'/'座號' 欄位。"); headers = { number: 0, name: 1, gender: 2, needs: 3 }; dataStartIndex = 0; } } else { alert('未偵測到標頭列，將嘗試預設 A, B, C, D 欄位。'); headers = { number: 0, name: 1, gender: 2, needs: 3 }; dataStartIndex = 0; }
                     let studentListText = ''; for (let i = dataStartIndex; i < jsonData.length; i++) { const row = jsonData[i]; const number = String(row[headers.number] ?? '').trim(); const name = String(row[headers.name] ?? '').trim(); const gender = String(row[headers.gender] ?? '').trim(); const needs = String(row[headers.needs] ?? '').trim(); if (name && (number || gender)) { studentListText += `${number || '?'} ${name} ${gender || '未知'}${needs ? ' ' + needs : ''}\n`; } }
                     if (!studentListText) { alert('在 Excel 中找不到有效的學生資料。'); return; }
                     this.elements.studentsTextarea.value = studentListText.trim(); fileInput.value = '';
                     this.arrangeSeats(); alert('學生名單已成功從 Excel 匯入並重新排列座位！');
                 } catch (error) { console.error("Excel import error:", error); alert(`讀取 Excel 失敗：${error.message}`); } };
                 reader.onerror = (error) => { console.error("File reading error:", error); alert('無法讀取檔案。'); }; reader.readAsArrayBuffer(file);
            }
            exportSeatingLayout() {
                 this.updateLayoutMapBasedOnDOM();
                 const totalDeskCount = this.elements.seatingChart.querySelectorAll('.desk').length; if (this.state.layoutMap.size === 0 && totalDeskCount === 0) { alert("沒有座位資料可匯出。"); return; }
                 const wb = this.xlsx.utils.book_new(); const wsData = []; const EMPTY_SEAT_TEXT = '--- 空位 ---';
                 if (this.state.seatingMode === 'traditional') {
                     wsData.push(['座位表 (傳統模式)']); wsData.push([`班級: ${this.state.className || '(未命名)'}`]); wsData.push([]);
                     const rows = this.state.rows; const cols = this.state.cols;
                     const rowIndices = this.state.viewPerspective === 'teacher' ? Array.from({ length: rows }, (_, i) => i) : Array.from({ length: rows }, (_, i) => rows - 1 - i);
                     const colIndices = this.state.viewPerspective === 'teacher' ? Array.from({ length: cols }, (_, j) => j) : Array.from({ length: cols }, (_, j) => cols - 1 - j);
                     const headerRow = ['列 \\ 行']; colIndices.forEach(j => headerRow.push(`第 ${j + 1} 行`)); wsData.push(headerRow);
                     rowIndices.forEach(i => { const rowData = [`第 ${i + 1} 列`]; colIndices.forEach(j => { const seatId = `r${i}c${j}`; const student = this.state.layoutMap.get(seatId); rowData.push(student ? `${student.number||'?'} ${student.name||'?'} (${student.gender||'?'})${student.needs ? ` [${student.needs}]`:''}` : EMPTY_SEAT_TEXT); }); wsData.push(rowData); });
                 } else {
                     wsData.push(['座位表 (小組模式)']); wsData.push([`班級: ${this.state.className || '(未命名)'}`]); wsData.push([]);
                     wsData.push(['小組名稱', '組內順序 (依畫面)', '學生 (座號 姓名 性別 [需求])']);
                     const groupContainers = Array.from(this.elements.seatingChart.querySelectorAll('.group-container'));
                     if (groupContainers.length === 0) { wsData.push(['(沒有任何小組)', '', '']); } else {
                         groupContainers.forEach((container) => {
                             const groupKey = container.dataset.groupKey; const groupIndex = parseInt(groupKey?.substring(1) ?? -1); const groupNameState = this.state.groupNames[groupKey]; const groupName = (groupNameState === undefined || groupNameState === null) ? `第 ${groupIndex + 1} 組` : (groupNameState === '' ? '(未命名小組)' : groupNameState);
                             wsData.push([`--- ${groupName} ---`, '', '']);
                             const desks = Array.from(container.querySelectorAll('.desk'));
                             if (desks.length === 0) { wsData.push(['', '(此組無座位)', '']); } else {
                                 desks.forEach((desk, visualSeatIndex) => { const deskId = desk.dataset.deskId; const student = this.state.layoutMap.get(deskId); wsData.push(['', `座位 ${visualSeatIndex + 1}`, student ? `${student.number||'?'} ${student.name||'?'} (${student.gender||'?'})${student.needs ? ` [${student.needs}]`:''}` : EMPTY_SEAT_TEXT]); });
                             }
                             wsData.push([]);
                         });
                     }
                 }
                 const ws = this.xlsx.utils.aoa_to_sheet(wsData); const colWidths = wsData.reduce((widths, row) => { row.forEach((cell, colIndex) => { const cellLen = cell ? String(cell).length : 0; widths[colIndex] = Math.max(widths[colIndex] || 8, cellLen + 2); }); return widths; }, []); ws['!cols'] = colWidths.map(wch => ({ wch: Math.min(wch, 50) }));
                 const sheetName = (this.state.className || '座位表').substring(0, 30); this.xlsx.utils.book_append_sheet(wb, ws, sheetName);
                 const date = new Date(); const dateString = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
                 const filename = `${this.state.className || '座位表'}_佈局_${dateString}.xlsx`;
                 try { this.xlsx.writeFile(wb, filename); } catch (e) { console.error("Excel export error:", e); alert(`匯出失敗: ${e.message}`); }
            }

            shuffleArray(array) { const newArray = [...array]; for (let i = newArray.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [newArray[i], newArray[j]] = [newArray[j], newArray[i]]; } return newArray; }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof XLSX === 'undefined') { alert("錯誤：無法載入 Excel 函式庫。"); }
            if (typeof Sortable === 'undefined') { alert("錯誤：無法載入拖曳排序函式庫。"); }
            if (typeof FileSaver === 'undefined') { alert("錯誤：無法載入檔案儲存函式庫。"); }
            window.classroomManager = new ClassroomSeatingManager();

            // --- NEW: Mascot Interaction Logic ---
            const mascotElement = document.getElementById('mascot');
            if (mascotElement) {
                function createParticle(x, y) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    document.body.appendChild(particle);

                    const size = Math.floor(Math.random() * 10 + 5);
                    const colors = ['#06b6d4', '#3b82f6', '#8b5cf6', '#f97316', '#ec4899', '#10b981', '#7c3aed']; // cyan, blue, purple, orange, pink, teal, violet
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.background = color;
                    particle.style.left = `${x - size / 2}px`;
                    particle.style.top = `${y - size / 2}px`;

                    const destinationX = (Math.random() - 0.5) * 300;
                    const destinationY = (Math.random() - 0.5) * 300;
                    const rotation = Math.random() * 520;
                    
                    requestAnimationFrame(() => {
                        particle.style.transform = `translate(${destinationX}px, ${destinationY}px) rotate(${rotation}deg)`;
                        particle.style.opacity = '0';
                    });
                    
                    setTimeout(() => {
                        particle.remove();
                    }, 1000);
                }

                mascotElement.addEventListener('click', (e) => {
                    for (let i = 0; i < 30; i++) {
                        createParticle(e.clientX, e.clientY);
                    }
                });
            }
        });
    </script>
</body>
</html>